
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.4.2, mkdocs-material-8.2.5">
    
    
      
        <title>Control de dispositivos SPI - BEE Docs</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.2d9f7617.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.e6a45f82.min.css">
        
      
    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#control-de-dispositivos-spi" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="BEE Docs" class="md-header__button md-logo" aria-label="BEE Docs" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            BEE Docs
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Control de dispositivos SPI
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  

<nav class="md-nav md-nav--primary md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="BEE Docs" class="md-nav__button md-logo" aria-label="BEE Docs" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    BEE Docs
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_1" type="checkbox" id="__nav_1" >
      
      
      
      
        <label class="md-nav__link" for="__nav_1">
          Documentación Técnica
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Documentación Técnica" data-md-level="1">
        <label class="md-nav__title" for="__nav_1">
          <span class="md-nav__icon md-icon"></span>
          Documentación Técnica
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        Placa de expansión BEE
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_2">
          Prácticas
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Prácticas" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Prácticas
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../gpio_linux/" class="md-nav__link">
        Control GPIO en Linux
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../pwm_linux/" class="md-nav__link">
        Control PWM en Linux
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Control de dispositivos SPI
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Control de dispositivos SPI
      </a>
      
        

  

<nav class="md-nav md-nav--secondary" aria-label="On this page">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      On this page
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#bus-spi" class="md-nav__link">
    Bus SPI
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#driver-spi-en-linux" class="md-nav__link">
    Driver SPI en Linux
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ejemplos-mcp3008-y-dac-mcp4911" class="md-nav__link">
    Ejemplos: MCP3008 y DAC MCP4911
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../i2c_linux/" class="md-nav__link">
        Control de dispositivos I2C
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../control_servomotores/" class="md-nav__link">
        Control de servomotores con PWM
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../robotica/" class="md-nav__link">
        Prácticas de Robótica
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                


<h1 id="control-de-dispositivos-spi">Control de dispositivos SPI<a class="headerlink" href="#control-de-dispositivos-spi" title="Permanent link">&para;</a></h1>
<p>En esta práctica vamos a ver cómo podemos manejar dispositivos conectados al
controlador spi utilizando el driver spi de Linux. Comenzaremos recordando
brevemente el funcionamiento del bus spi, ya que es necesario entenrlo para
manejar el driver y los dispositivos. Al final probaremos lo que hemos aprendido
utilizando el ADC incluido en la placa BEE.</p>
<h2 id="bus-spi">Bus SPI<a class="headerlink" href="#bus-spi" title="Permanent link">&para;</a></h2>
<p>El Serial Peripheral Interface (SPI) es un bus serie síncrono y bidirccional muy
utilizado en sistemas empotrados para conectar un microcontrolador a sus
periféricos. Puede trabajar con frecuencias de 1 a 20 MHz, pero sólo un
dispositivo puede ser máster del bus. El bus utiliza 4 líneas más una tierra
común:</p>
<ul>
<li>Master out/Slave in (<em>MOSI</em>, <em>SDI</em>)</li>
<li>Master in/Slave out (<em>MISO</em>, <em>SDO</em>)</li>
<li>Serial clock (<em>SCK</em>)</li>
<li>Slave Select (<em>nSS</em>):  activo a baja</li>
</ul>
<p>Los dispositivos SPI pueden funcionar en dos modos</p>
<ul>
<li><strong>Master</strong>: es el que puede iniciar y controlar una transferencia</li>
<li><strong>Slave</strong>: es el que se comunica con un master que le active</li>
</ul>
<p>El máster selecciona al slave con el que quiere comunicarse activando su señal
SS (poniéndola a 0). Si un dispositivo puede hacer de máster o slave, puede
configurar el pin <em>nSS</em> como entrada para ver si otro módulo está actuando como
master. Si se detecta otro máster el dispositivo debe configurarse en modo
slave. </p>
<p><img alt="SPI conexiones" src="fig/SPI-slave.jpg" /></p>
<p>En SPI el envío y la recepción suceden simultáneamente, el bus funciona como un
registro de desplazamiento circular distribuido. Se suele utilizar un sistema de
doble buffer. El master y el slave tienen un registro de datos de 8 bits
utilizado por el software para escribir el dato a transmitir o leer el dato
recibido. También disponen de un registro de desplazamiento de 8 bits. </p>
<p>El procediminto de transmisión se ilustra en la figura de abajo. Pongamos por
ejemplo que el master quiere envíar un byte a un esclavo. Para transmitir se
empieza copiando el dato en el registro de datos, que después se copia en el
registro de desplazamiento. Luego, en cada pulso de la señal <em>SCK</em> (generada por
el máster) se desplaza una posición el contenido de éste registro, enviando así
por la línea MOSI un bit. El esclavo hace el mismo desplazamiento, enviando a su
vez un bit al master por la linea MISO. Ambos dispositivos usan el bit recibido
como bit de relleno de su registro de desplazamiento. Este procedimiento
continúa hasta que se hayan transmitido los 8 bits. Es configurable si se
rellena por el bit más significativo (MSB) o menos significativo (LSB).</p>
<p><img alt="SPI transmisión" src="fig/spi_master_slave.png" /></p>
<p>SPI tiene esencialmente dos modos de transmisión, ilustrados en la figura de
abajo, que son:</p>
<ul>
<li>
<p>CPHA = 0: </p>
<ul>
<li>El slave puede poner el primer bit en <em>MISO</em> en cuanto es seleccionado</li>
<li>Los bits son latcheados/capturados en flancos impares de <em>SCK</em> </li>
<li>El shifter se desplaza en flancos pares de <em>SCK</em>, rellenando con el bit
  capturado y transmitiendo así un nuevo bit</li>
</ul>
</li>
<li>
<p>CPHA = 1:</p>
<ul>
<li>El slave necesita un flanco en SCK para poner el primer bit en <em>MISO</em></li>
<li>Los bits son latcheados/capturados en flancos pares de <em>SCK</em></li>
<li>El shifter se desplaza en flancos impares de <em>SCK</em>, 
  rellenando con el bit capturado y transmitiendo así un nuevo bit</li>
</ul>
</li>
</ul>
<p>Estos dos modos tienen a su vez dos variantes que determinan la polaridad de
<em>SCK</em>:
    - <em>CPOL = 0</em>: SCK activo a alta, inactivo a baja
    - <em>CPOL = 1</em>: SCK activo a baja, inactivo a alta</p>
<p><img alt="SPI timing" src="fig/SPI_timing.png" /></p>
<h2 id="driver-spi-en-linux">Driver SPI en Linux<a class="headerlink" href="#driver-spi-en-linux" title="Permanent link">&para;</a></h2>
<p>Linux proporciona un driver spi genérico, que expone controladores como
dispositivos de caracteres (<em>/dev/spidev#.#</em>). Para realizar una transmisión, lo
primero es abrir el fichero de dispositivo. Después usaremos una serie de
operaciones <em>ioctl</em> para configurar el modo de transmisión requerido por el
dispositivo:</p>
<ul>
<li><em>SPI_IOC_RD_MODE</em>, <em>SPI_IOC_WR_MODE</em>: recibe un puntero a byte para leer o
  escribir el modo de transmisión básico. Los valores válidos son:
  <em>SPI_MODE_{0,1,2,3}</em></li>
<li><em>SPI_IOC_RD_LSB_FIRST</em>, <em>SPI_IOC_WR_LSB_FIRST</em>: recibe un puntero a byte para
  leer o escribir el bit order. Un valor 0 es MSB first y cualquier otro valor
  es LSB first.</li>
<li><em>SPI_IOC_RD_BITS_PER_WORD</em>, <em>SPI_IOC_WR_BITS_PER_WORD</em>: recibe un puntero a
  byte, para leer o escribir el número de bits en cada palabra spi transferida.
  Un valor 0 significa 8 bits.</li>
<li><em>PI_IOC_RD_MAX_SPEED_HZ</em>, <em>SPI_IOC_WR_MAX_SPEED_HZ</em>: recibe un puntero a
  uint32 para leer o escribir la frecuencia de transmisión.</li>
</ul>
<p>Una vez configurado el modo de transmisión, usaremos una operación
<em>SPI_IOC_MESSAGE(n)</em> para realizar envío y recepción simultáneos. Esta operación
recibe un puntero a un array de <strong>n</strong> elementos del tipo <code>struct
spi_ioc_transfer</code>:</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">spi_ioc_transfer</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="w">    </span><span class="n">__u64</span><span class="w"> </span><span class="n">tx_buf</span><span class="p">;</span><span class="w">  </span><span class="c1">// dirección del buffer para transmision</span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="w">    </span><span class="n">__u64</span><span class="w"> </span><span class="n">rx_buf</span><span class="p">;</span><span class="w">  </span><span class="c1">// dirección del buffer para recepción</span>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="w">    </span><span class="n">__u32</span><span class="w"> </span><span class="n">len</span><span class="p">;</span><span class="w">     </span><span class="c1">// longitud de tx_buf y rx_buf</span>
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="w">    </span><span class="n">__u32</span><span class="w"> </span><span class="n">speed_hz</span><span class="p">;</span><span class="c1">// velocidad para esta transferencia</span>
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="w">    </span><span class="n">__u16</span><span class="w"> </span><span class="n">delay_usecs</span><span class="p">;</span><span class="w">   </span><span class="c1">// retardo para subir nCS</span>
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a><span class="w">    </span><span class="n">__u8</span><span class="w">  </span><span class="n">bits_per_word</span><span class="p">;</span><span class="w"> </span><span class="c1">// bits por palabra</span>
</span><span id="__span-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a><span class="w">    </span><span class="n">__u8</span><span class="w">  </span><span class="n">cs_change</span><span class="p">;</span><span class="w">     </span><span class="c1">// subir nCS entre medias</span>
</span><span id="__span-0-11"><a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a><span class="w">    </span><span class="n">__u8</span><span class="w">  </span><span class="n">tx_nbits</span><span class="p">;</span><span class="w">      </span><span class="c1">// num de bits a transmitir</span>
</span><span id="__span-0-12"><a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a><span class="w">    </span><span class="n">__u8</span><span class="w">  </span><span class="n">rx_nbits</span><span class="p">;</span><span class="w">      </span><span class="c1">// num de bits a recibir</span>
</span><span id="__span-0-13"><a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a><span class="w">    </span><span class="n">__u8</span><span class="w">  </span><span class="n">word_delay_usecs</span><span class="p">;</span><span class="w"> </span><span class="c1">// retardo entre palabras</span>
</span><span id="__span-0-14"><a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a><span class="w">    </span><span class="n">__u8</span><span class="w">  </span><span class="n">pad</span><span class="p">;</span>
</span><span id="__span-0-15"><a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a><span class="p">};</span>
</span></code></pre></div>
<h2 id="ejemplos-mcp3008-y-dac-mcp4911">Ejemplos: MCP3008 y DAC MCP4911<a class="headerlink" href="#ejemplos-mcp3008-y-dac-mcp4911" title="Permanent link">&para;</a></h2>
<p>El MCP3008 es un ADC de 10 bits y 8 canales, que pueden ser utilizados en modo
diferencial o en modo independiente. Este ADC tiene un interfaz SPI. La placa
BEE tiene montado uno de estos ADCs, que podemos conectar a la Raspberry Pi a
través de los jumpers en la tira de pines J2. La siguiente figura muestra un
cronograma de una comunicación SPI entre un microcontrolador y el ADC, extraída
de la <a href="http://ww1.microchip.com/downloads/en/DeviceDoc/21295d.pdf">hoja de características del
MCP3008</a>
(<em>datasheet</em>) proporcionada por el fabricante:</p>
<p><img alt="MCP3008 crono" src="fig/mcp3008_crono.png" /></p>
<p>El siguiente código es un ejemplo de cómo leer el ADC utilizando el driver SPI
explicado arriba, siguiendo las directrices del cronograma:</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="cp">#define MCP3008_START 0x1</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a><span class="cp">#define MCP3008_SIGL_DIFF (0x1 &lt;&lt; 7)</span>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a><span class="n">__u8</span><span class="w"> </span><span class="n">spi_mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">__u8</span><span class="p">)</span><span class="w"> </span><span class="n">SPI_MODE_0</span><span class="p">;</span>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a><span class="kt">int</span><span class="w"> </span><span class="n">channel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a><span class="k">struct</span><span class="w"> </span><span class="nc">spi_ioc_transfer</span><span class="w"> </span><span class="n">xfer</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a><span class="kt">unsigned</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
</span><span id="__span-1-8"><a id="__codelineno-1-8" name="__codelineno-1-8" href="#__codelineno-1-8"></a><span class="kt">int</span><span class="w"> </span><span class="n">adcval</span><span class="p">;</span>
</span><span id="__span-1-9"><a id="__codelineno-1-9" name="__codelineno-1-9" href="#__codelineno-1-9"></a>
</span><span id="__span-1-10"><a id="__codelineno-1-10" name="__codelineno-1-10" href="#__codelineno-1-10"></a><span class="n">fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">open</span><span class="p">(</span><span class="s">&quot;/dev/spidev0.0&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">O_RDWR</span><span class="p">);</span>
</span><span id="__span-1-11"><a id="__codelineno-1-11" name="__codelineno-1-11" href="#__codelineno-1-11"></a><span class="n">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="n">SPI_IOC_WR_MODE</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">spi_mode</span><span class="p">);</span>
</span><span id="__span-1-12"><a id="__codelineno-1-12" name="__codelineno-1-12" href="#__codelineno-1-12"></a>
</span><span id="__span-1-13"><a id="__codelineno-1-13" name="__codelineno-1-13" href="#__codelineno-1-13"></a><span class="n">memset</span><span class="p">(</span><span class="n">xfer</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="w"> </span><span class="n">xfer</span><span class="p">);</span>
</span><span id="__span-1-14"><a id="__codelineno-1-14" name="__codelineno-1-14" href="#__codelineno-1-14"></a><span class="n">memset</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="w"> </span><span class="n">buf</span><span class="p">);</span>
</span><span id="__span-1-15"><a id="__codelineno-1-15" name="__codelineno-1-15" href="#__codelineno-1-15"></a>
</span><span id="__span-1-16"><a id="__codelineno-1-16" name="__codelineno-1-16" href="#__codelineno-1-16"></a><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MCP3008_START</span><span class="p">;</span>
</span><span id="__span-1-17"><a id="__codelineno-1-17" name="__codelineno-1-17" href="#__codelineno-1-17"></a><span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MCP3008_SIGL_DIFF</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">((</span><span class="n">channel</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x7</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">4</span><span class="p">);</span>
</span><span id="__span-1-18"><a id="__codelineno-1-18" name="__codelineno-1-18" href="#__codelineno-1-18"></a><span class="n">xfer</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">tx_buf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">__u64</span><span class="p">)</span><span class="w"> </span><span class="n">buf</span><span class="p">;</span>
</span><span id="__span-1-19"><a id="__codelineno-1-19" name="__codelineno-1-19" href="#__codelineno-1-19"></a><span class="n">xfer</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">rx_buf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">__u64</span><span class="p">)</span><span class="w"> </span><span class="n">buf</span><span class="p">;</span>
</span><span id="__span-1-20"><a id="__codelineno-1-20" name="__codelineno-1-20" href="#__codelineno-1-20"></a><span class="n">xfer</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">sizeof</span><span class="w"> </span><span class="n">buf</span><span class="p">;</span>
</span><span id="__span-1-21"><a id="__codelineno-1-21" name="__codelineno-1-21" href="#__codelineno-1-21"></a><span class="n">xfer</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">speed_hz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1350000</span><span class="p">;</span><span class="w"> </span><span class="c1">//1.35 MHz</span>
</span><span id="__span-1-22"><a id="__codelineno-1-22" name="__codelineno-1-22" href="#__codelineno-1-22"></a><span class="n">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="n">SPI_IOC_MESSAGE</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="n">xfer</span><span class="p">);</span>
</span><span id="__span-1-23"><a id="__codelineno-1-23" name="__codelineno-1-23" href="#__codelineno-1-23"></a><span class="n">adcval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x3</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
</span></code></pre></div>
<p>El programa <a href="src/adc_read.c">adc_read.c</a> lee una vez por segundo el valor de uno
de los canales del adc de la placa BEE y muestra la tensión correspondiente a la 
medida por la salida estándar. Para usarlo podemos ejecutar el programa con los
siguientes parámetros:</p>
<p><div class="language-c highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="p">.</span><span class="o">/</span><span class="n">adc_read</span><span class="w"> </span><span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">spidev0</span><span class="mf">.0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">3300</span>
</span></code></pre></div>
- <em>/dev/spidev0.0</em>: es el controlador spi a usar
- <em>0</em>: el canal del adc que leer
- <em>3300</em>: la tensión vdd que alimenta al ADC en mV.</p>
<p>El programa <a href="src/dac_follow_adc.c">dac_follow_adc.c</a> es similar al anterior,
pero además copia en el dac el valor leído del adc, de modo que la salida del
dac va siguiendo la entrada del adc.</p>
<p>Para comprobar el funcionamiento de estos programas deben conectarse una serie
de jumpers en la BEE:</p>
<ul>
<li>Jumpers en la tira de pines J2</li>
<li>Jumpers para selección de VDD y VCC en J14 y J18 (escoger 3.3V)</li>
<li>Jumper de tensión de referencia del ADC en J11.</li>
<li>Jumper de tensión de referencia del DAC (no numerado).</li>
<li>Jumper J9 de nLDAC.</li>
</ul>

              
            </article>
          </div>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Footer">
      
        
        <a href="../pwm_linux/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Control PWM en Linux" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Control PWM en Linux
            </div>
          </div>
        </a>
      
      
        
        <a href="../i2c_linux/" class="md-footer__link md-footer__link--next" aria-label="Next: Control de dispositivos I2C" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              Control de dispositivos I2C
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "..", "features": ["toc.integrate"], "search": "../assets/javascripts/workers/search.bd0b6b67.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.467223ff.min.js"></script>
      
        <script src="../javascripts/mathjax.js"></script>
      
        <script src="https://unpkg.com/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>