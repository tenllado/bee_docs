
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.4.2, mkdocs-material-8.2.5">
    
    
      
        <title>Control de dispositivos I2C - BEE Docs</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.2d9f7617.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.e6a45f82.min.css">
        
      
    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#control-de-dispositivos-i2c" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="BEE Docs" class="md-header__button md-logo" aria-label="BEE Docs" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            BEE Docs
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Control de dispositivos I2C
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  

<nav class="md-nav md-nav--primary md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="BEE Docs" class="md-nav__button md-logo" aria-label="BEE Docs" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    BEE Docs
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_1" type="checkbox" id="__nav_1" >
      
      
      
      
        <label class="md-nav__link" for="__nav_1">
          Documentación Técnica
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Documentación Técnica" data-md-level="1">
        <label class="md-nav__title" for="__nav_1">
          <span class="md-nav__icon md-icon"></span>
          Documentación Técnica
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        Placa de expansión BEE
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_2">
          Prácticas
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Prácticas" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Prácticas
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../gpio_linux/" class="md-nav__link">
        Control GPIO en Linux
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../pwm_linux/" class="md-nav__link">
        Control PWM en Linux
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../spi_linux/" class="md-nav__link">
        Control de dispositivos SPI
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Control de dispositivos I2C
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Control de dispositivos I2C
      </a>
      
        

  

<nav class="md-nav md-nav--secondary" aria-label="On this page">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      On this page
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#bus-i2c" class="md-nav__link">
    Bus I2C
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#i2c-en-linux" class="md-nav__link">
    I2C en Linux
  </a>
  
    <nav class="md-nav" aria-label="I2C en Linux">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ejemplo-de-transacciones-i2c-estandar" class="md-nav__link">
    Ejemplo de transacciones I2C estándar
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ejemplo-de-transaccion-i2c-encadenada" class="md-nav__link">
    Ejemplo de transacción I2C encadenada
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ejemplo-de-transaccion-smbus" class="md-nav__link">
    Ejemplo de transacción SMBus
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ejemplo-lectura-del-sensor-inertial-one" class="md-nav__link">
    Ejemplo: lectura del sensor Inertial One
  </a>
  
    <nav class="md-nav" aria-label="Ejemplo: lectura del sensor Inertial One">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ejercicio" class="md-nav__link">
    Ejercicio
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../control_servomotores/" class="md-nav__link">
        Control de servomotores con PWM
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../robotica/" class="md-nav__link">
        Prácticas de Robótica
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                


<h1 id="control-de-dispositivos-i2c">Control de dispositivos I2C<a class="headerlink" href="#control-de-dispositivos-i2c" title="Permanent link">&para;</a></h1>
<p>Para probar los códigos utilizados en los ejemplos de esta práctica necesitamos
disponer de una placa <a href="https://ww1.microchip.com/downloads/en/Appnotes/doc8354.pdf">Inertial One
ATAVRSBIN1</a>.</p>
<p>A lo largo de la práctica repasaremos los conceptos básicos del bus I2C y
veremos cómo podemos comunicarnos con los dispositivos I2C utilizando las
utilidades incluidas en Linux, así como el driver I2C genérico incluido.</p>
<h2 id="bus-i2c">Bus I2C<a class="headerlink" href="#bus-i2c" title="Permanent link">&para;</a></h2>
<p>El Inter-Integrated Circuit (IIC/\IIC{}/I2C) es un bus serie diseñado por
Philips en década del 1980 para la interconexión de periféricos a un
microcontrolador. Proporciona una conexión serie síncrona unidireccional
(halfduplex). Los dispositivos pueden ser máster o slave, permitiéndose la
presencia de varios másters en el bus. El protocolo de trasmisión incorpora un
mecanismo de arbitraje que permite seleccionar el máster que toma el control del
bus en caso de que varios quieran enviar simultáneamente.</p>
<p>El máster es quien inicia y finaliza cada transferencia. Direcciona al esclavo
con el que se quiere comunicar y genera la señal de reloj. El esclavo no puede
enviar o recibir por su cuenta. El bus puede trabajar a varias velocidades:
100Kb/s, 400Kb/s, 1Mb/s, 3.4Mb/s y 5Mb/s y sólo utiliza dos líneas, además de la
tierra común: Serial Data (SDA), que lleva los datos, y Serial Clock (SCL), que
lleva la señal de reloj generada por el master.</p>
<p>En los últimos años se han popularizado algunas variantes de I2C utlizadas en
los computadores personales para el control de algunos sensores, como son
SMBus y PMBus. Estos protocolos pueden utilizarse igual con el driver I2C de
Linux.</p>
<p>Las conexiones a las línea van en colector/drenador abierto (<em>open
drain/collector</em>). Se emplean resistencias de <em>pull-up</em> externas, de 4.7 K
típicamente, que dejan la linea a Vdd en reposo. Los dispositivos pueden poner
(forzar) las líneas a 0 (<em>OR</em> cableada).</p>
<p><img alt="I2C open-drain" src="fig/I2C-open-drain.png" /></p>
<p>La siguiente figura ilustra las sincronizaciones de comienzo y fin de una
transacción I2C. Primero el máster envía comando <em>START</em>, una transición Alto a
Bajo de SDA, con SCL en alto. A partir de ese momento el bus se considera
ocupado y se procede al envío de datos (trama), generándose un pulso en <em>SCL</em>
por cada bit transferido. El receptor puede mantener <em>SCL</em> baja en cualquier
momento si quiere alargar el ciclo de reloj (forzar una espera del master).
La señal SDA se debe mantener estable mientras SCL está alta. Cuando se han
enviado todos los bits de la transacción el máster envía comando <em>STOP</em>, una
transacción Bajo a Alto de SDA con SCL en alto. El bus queda libre tras este
comando de <em>STOP</em>.</p>
<p><img alt="I2C sincronización" src="fig/IIC_sinc.png" /></p>
<p>La siguiente figura detalla la estructura de la trama. Como podemos ver, tras el
comando <em>Start</em> hay un byte de dirección, que se compone de:</p>
<ul>
<li>7 bits de dirección del esclavo, empezando por el más significativo</li>
<li>1 bit de tipo de operación: R/nW</li>
<li>1 bit de ACK</li>
</ul>
<p>A continuación se envían uno o más bytes de datos, cada uno de ellos seguidos de
un bit de ACK que debe poner a 0 el receptor. Los bytes de datos se envían
también empezando por el bit más significativo. La transacción termina
normalmente con el envío de un comando de <em>STOP</em>. Pero se quiere evitar perder
el bus, el máster puede decidir envía un comando de <em>START</em> en lugar del <em>STOP</em>
(que se llama <em>START</em> repetido), comenzando diréctamente una nueva transmisión.</p>
<p><img alt="Trama I2C" src="fig/IIC_address_rw.png" /></p>
<p>Así, una transmisión de escritura, en la que un máster envía un dato a un
esclavo tendría la siguiente estructura:</p>
<p><img alt="I2C escritura" src="fig/IIC_ejemplo_escritura.png" /></p>
<p>El máster envía un primer byte de dirección del esclavo, indicado el que quiere
escribir. Luego suele enviar un byte de comando, que direcciona el registro en
el que quiere escribir, seguido del dato a escribir.</p>
<p>La operación de lectura normalmente va precedida de una operación de escritura
en la que se envía el comando de lectura, indicando el registro del que se
quiere leer. Después se realiza la operación de lectura propiamente dicha, en la
que el primer byte direcciona el dispositivo y se indique que se quiere hacer
una lectura, y el máster luego genera los suficientes pulsos de reloj para leer
los bytes que enviará el esclavo, activando como corresponda el bit de ACK en
cada byte transferido.</p>
<p><img alt="I2C lectura" src="fig/IIC_ejemplo_lectura.png" /></p>
<p>I2C contempla la posibilidad de utilizar direcciones de 10 bits. Para ello, se
reservan las direcciones <em>11110xy</em> para indicar que la dirección es de 10 bits:</p>
<ul>
<li>Los bits <em>xy</em> serán los dos bits más significativos de la dirección</li>
<li>Los 8 bits restantes se envían en el siguiente byte</li>
</ul>
<p>No lo soportan todos los controladores I2C, ni es soportado por dispositivos
SMBus. En transacciones escritura-lectura encadenadas sólo se repite el primer
byte de la dirección. En este caso, el esquema de una operación de escritura
es como indica la siguiente figura:</p>
<p><a href="fig/IIC_write_10bitadd.png">I2C write 10 bit address</a></p>
<p>La lectura con un dispositivo con dirección de 10 bits se ilustra en la
siguiente figura:</p>
<p><a href="fig/IIC_read_10bitadd.png">I2C read 10 bit address</a></p>
<p>Existen otras extensiones al bus I2C, que pueden consultarse en la
<a href="https://www.i2c-bus.org/specification/">especificación de I2C</a>.</p>
<h2 id="i2c-en-linux">I2C en Linux<a class="headerlink" href="#i2c-en-linux" title="Permanent link">&para;</a></h2>
<p>El driver I2C de Linux expone dispositivos de caracteres <em>/dev/i2c-#</em>. Para ello
es necesario cargar el módulo i2c-dev. Por cada controlador I2C del SoC
aparecerá un fichero en <em>/sys/class/i2c-dev/</em>.</p>
<p>El paquete i2c-tools (puede instalarse con <code>apt-get install i2c-tools</code>) nos da
algunas herramientas interesantes:</p>
<ul>
<li><em>i2cdetect -l</em>: nos da una lista de controladores i2c en el sistema</li>
<li><em>i2cdetect -y #</em>: escanea el bus <em>i2c-#</em> y nos dice los dispositivos
  detectados y sus direcciones</li>
<li><em>i2cget</em>: permite leer registros de dispositivos conectados al bus. Por
  ejemplo:</li>
</ul>
<p><div class="language-sh highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a>i2cget<span class="w"> </span>-y<span class="w">  </span><span class="m">1</span><span class="w"> </span>0x68<span class="w"> </span>0x1c<span class="w"> </span>b
</span></code></pre></div>
- <em>i2cset</em>: permite escribir en registros de dispositivos conectados al bus.
- <em>i2ctransfer</em>: nos permite hacer transferencias encadenadas con <em>slaves</em>
  conectados al bus. Por ejemplo:</p>
<div class="language-sh highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a>i2ctransfer<span class="w"> </span>-y<span class="w"> </span><span class="m">1</span><span class="w"> </span>w1@0x68<span class="w"> </span>0x1c<span class="w"> </span>r1
</span></code></pre></div>
<p>Hay tres tipos de transaccionees soportadas por el driver:</p>
<ul>
<li>
<p>Transacciones I2C estándar:</p>
<ul>
<li>Operaciones <em>read/write</em> independientes</li>
<li>Bit de stop detrás de cada una</li>
<li>Para leer un registro primero hacemos una op de escritura con el número
  del registro y luego una operación de lectura para leer el valor</li>
</ul>
</li>
<li>
<p>Transacciones I2C encadenadas con <em>ioctl</em></p>
<ul>
<li>Varias transacciones con una sola operación <em>ioctl</em> tipo <em>I2C_RDWR</em> </li>
<li>Por defecto con repeated start</li>
<li>Puede usarse para leer un registro, concatenando el write del comando con
  el read siguiente</li>
</ul>
</li>
<li>
<p>Transacciones SMBus</p>
<ul>
<li>API específico y simplificado implementado en la libi2c</li>
<li>Se prefiere su uso para dispositivos compatibles</li>
</ul>
</li>
</ul>
<p>El interfaz está documentado en
<a href="https://www.kernel.org/doc/Documentation/i2c/">www.kernel.org</a> y en los
ficheros de cabecera del driver: <a href="/usr/include/linux/i2c-dev.h">i2c-dev.h</a>,
<a href="/usr/include/linux/i2c.h">i2c.h</a> y <a href="/usr/include/i2c/smbus.h">smbus.h</a>.</p>
<p>Las operaciones <em>ioctl</em> soportadas por estos dispositivos son:</p>
<ul>
<li><em>I2C_SLAVE</em>: establece la dirección del esclavo, nos ahorramos tener que
  ponerla en cada operación</li>
<li><em>I2C_FUNCS</em>: nos permite consultar la funcionalidad disponible en el
  controlador</li>
<li><em>I2C_TENBIT</em>: selección del uso de direcciones de 10 bits. El controlador debe
  tener la funcionalidad <em>I2C_FUNC_10BIT_ADDR</em></li>
<li><em>I2C_RDWR</em>: Para realizar transacciones de lectura/escritura encadenadas, sin
  bit de stop entre ellas. El controlador debe tener <em>I2C_FUNC_I2C</em>.</li>
<li><em>I2C_PEC</em>: generación y verificación de Packet Error Checking para el
  protocolo SMBus. El controlador debe tener <em>I2C_FUNC_SMBUS_PEC</em></li>
<li><em>I2C_SMBUS</em>: Para transacciones SMBus.Se recomienda el uso de las funciones
  <em>i2c_smbus_*</em>, proporcionadas por la librería <em>libi2c</em> (paquete <em>i2c-tools</em>),
  que hacen de wrapper sobre la operación <em>ioctl</em></li>
</ul>
<p>SMBus es un subconjunto de I2C:</p>
<ul>
<li>Sólo admite direcciones de 7 bits</li>
<li>Sólo hasta 100 KHz</li>
<li>Timeout 35 ms, frecuencia mínima de 10 KHz</li>
</ul>
<p>El API implementado en libi2c opera sobre la operación ioctl <em>I2C_SMBUS</em>:</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="n">__s32</span><span class="w"> </span><span class="nf">i2c_smbus_write_quick</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="n">__u8</span><span class="w"> </span><span class="n">value</span><span class="p">);</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="n">__s32</span><span class="w"> </span><span class="nf">i2c_smbus_read_byte</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">file</span><span class="p">);</span>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a><span class="n">__s32</span><span class="w"> </span><span class="nf">i2c_smbus_write_byte</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="n">__u8</span><span class="w"> </span><span class="n">value</span><span class="p">);</span>
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a><span class="n">__s32</span><span class="w"> </span><span class="nf">i2c_smbus_read_byte_data</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="n">__u8</span><span class="w"> </span><span class="n">command</span><span class="p">);</span>
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a><span class="n">__s32</span><span class="w"> </span><span class="nf">i2c_smbus_write_byte_data</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="n">__u8</span><span class="w"> </span><span class="n">command</span><span class="p">,</span><span class="w"> </span><span class="n">__u8</span><span class="w"> </span><span class="n">value</span><span class="p">);</span>
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a><span class="n">__s32</span><span class="w"> </span><span class="nf">i2c_smbus_read_word_data</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="n">__u8</span><span class="w"> </span><span class="n">command</span><span class="p">);</span>
</span><span id="__span-2-7"><a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a><span class="n">__s32</span><span class="w"> </span><span class="nf">i2c_smbus_write_word_data</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="n">__u8</span><span class="w"> </span><span class="n">command</span><span class="p">,</span><span class="w"> </span><span class="n">__u16</span><span class="w"> </span><span class="n">value</span><span class="p">);</span>
</span><span id="__span-2-8"><a id="__codelineno-2-8" name="__codelineno-2-8" href="#__codelineno-2-8"></a><span class="cm">/* Returns the number of read bytes */</span>
</span><span id="__span-2-9"><a id="__codelineno-2-9" name="__codelineno-2-9" href="#__codelineno-2-9"></a><span class="n">__s32</span><span class="w"> </span><span class="nf">i2c_smbus_read_block_data</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="n">__u8</span><span class="w"> </span><span class="n">command</span><span class="p">,</span><span class="w"> </span><span class="n">__u8</span><span class="w"> </span><span class="o">*</span><span class="n">values</span><span class="p">);</span>
</span><span id="__span-2-10"><a id="__codelineno-2-10" name="__codelineno-2-10" href="#__codelineno-2-10"></a><span class="n">__s32</span><span class="w"> </span><span class="nf">i2c_smbus_write_block_data</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="n">__u8</span><span class="w"> </span><span class="n">command</span><span class="p">,</span><span class="w"> </span><span class="n">__u8</span><span class="w"> </span><span class="n">length</span><span class="p">,</span><span class="w"> </span>
</span><span id="__span-2-11"><a id="__codelineno-2-11" name="__codelineno-2-11" href="#__codelineno-2-11"></a><span class="w">                                 </span><span class="k">const</span><span class="w"> </span><span class="n">__u8</span><span class="w"> </span><span class="o">*</span><span class="n">values</span><span class="p">);</span>
</span></code></pre></div>
<p>El API completo se documenta en <em>/usr/include/i2c/smbus.h</em>.</p>
<h3 id="ejemplo-de-transacciones-i2c-estandar">Ejemplo de transacciones I2C estándar<a class="headerlink" href="#ejemplo-de-transacciones-i2c-estandar" title="Permanent link">&para;</a></h3>
<p>El siguiente código es un ejemplo de lectura de un registro de tamaño byte de un
sensor i2c, usando una transacción I2C estándar con el driver I2C de Linux:</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="kt">int</span><span class="w"> </span><span class="n">addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x68</span><span class="p">;</span><span class="w">              </span><span class="c1">// Dirección del sensor I2C</span>
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a><span class="kt">unsigned</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">regid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x1b</span><span class="p">;</span><span class="w">   </span><span class="c1">// Id del registro a leer</span>
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a><span class="kt">unsigned</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">buf</span><span class="p">;</span><span class="w">            </span><span class="c1">// buffer para el valor leído</span>
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a><span class="kt">int</span><span class="w"> </span><span class="n">fd</span><span class="p">;</span>
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a>
</span><span id="__span-3-6"><a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a><span class="n">fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">open</span><span class="p">(</span><span class="s">&quot;/dev/i2c-1&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">O_RDWR</span><span class="p">);</span>
</span><span id="__span-3-7"><a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a><span class="n">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="n">I2C_SLAVE</span><span class="p">,</span><span class="w"> </span><span class="n">addr</span><span class="p">);</span>
</span><span id="__span-3-8"><a id="__codelineno-3-8" name="__codelineno-3-8" href="#__codelineno-3-8"></a>
</span><span id="__span-3-9"><a id="__codelineno-3-9" name="__codelineno-3-9" href="#__codelineno-3-9"></a><span class="n">write</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">regid</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="w">  </span><span class="c1">// Transacción de escritura/comando</span>
</span><span id="__span-3-10"><a id="__codelineno-3-10" name="__codelineno-3-10" href="#__codelineno-3-10"></a><span class="n">read</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="w">     </span><span class="c1">// Transacción de lectura</span>
</span></code></pre></div>
<h3 id="ejemplo-de-transaccion-i2c-encadenada">Ejemplo de transacción I2C encadenada<a class="headerlink" href="#ejemplo-de-transaccion-i2c-encadenada" title="Permanent link">&para;</a></h3>
<p>El siguiente código es un ejemplo de una transacción encadenada con el driver de
I2C de Linux en el que se hace la misma lectura que en el ejemplo anterior, pero
encadenando la operación de escritura (que indica el registro a leer) y la
operación de lectura posterior:</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="kt">int</span><span class="w"> </span><span class="n">fd</span><span class="p">;</span><span class="w">                    </span><span class="c1">// descriptor de fichero</span>
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a><span class="kt">int</span><span class="w"> </span><span class="n">addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x68</span><span class="p">;</span><span class="w">           </span><span class="c1">// Dirección del sensor I2C</span>
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a><span class="kt">char</span><span class="w"> </span><span class="n">wbuf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mh">0x1b</span><span class="p">};</span><span class="w">     </span><span class="c1">// Id del registro a leer</span>
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a><span class="kt">char</span><span class="w"> </span><span class="n">rbuf</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span><span class="w">              </span><span class="c1">// buffer para el valor leído</span>
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a><span class="k">struct</span><span class="w"> </span><span class="nc">i2c_msg</span><span class="w"> </span><span class="n">msgs</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span><span class="w">    </span><span class="c1">// variables para la op ioctl</span>
</span><span id="__span-4-6"><a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a><span class="k">struct</span><span class="w"> </span><span class="nc">i2c_rdwr_ioctl_data</span><span class="w"> </span><span class="n">i2cdata</span><span class="p">;</span>
</span><span id="__span-4-7"><a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a>
</span><span id="__span-4-8"><a id="__codelineno-4-8" name="__codelineno-4-8" href="#__codelineno-4-8"></a><span class="c1">// Transacción de escritura / comando</span>
</span><span id="__span-4-9"><a id="__codelineno-4-9" name="__codelineno-4-9" href="#__codelineno-4-9"></a><span class="n">msgs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">addr</span><span class="p">;</span>
</span><span id="__span-4-10"><a id="__codelineno-4-10" name="__codelineno-4-10" href="#__codelineno-4-10"></a><span class="n">msgs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">flags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-4-11"><a id="__codelineno-4-11" name="__codelineno-4-11" href="#__codelineno-4-11"></a><span class="n">msgs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
</span><span id="__span-4-12"><a id="__codelineno-4-12" name="__codelineno-4-12" href="#__codelineno-4-12"></a><span class="n">msgs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">buf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wbuf</span><span class="p">;</span>
</span><span id="__span-4-13"><a id="__codelineno-4-13" name="__codelineno-4-13" href="#__codelineno-4-13"></a><span class="c1">// Transacción de lectura</span>
</span><span id="__span-4-14"><a id="__codelineno-4-14" name="__codelineno-4-14" href="#__codelineno-4-14"></a><span class="n">msgs</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">addr</span><span class="p">;</span>
</span><span id="__span-4-15"><a id="__codelineno-4-15" name="__codelineno-4-15" href="#__codelineno-4-15"></a><span class="n">msgs</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">flags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">I2C_M_RD</span><span class="p">;</span>
</span><span id="__span-4-16"><a id="__codelineno-4-16" name="__codelineno-4-16" href="#__codelineno-4-16"></a><span class="n">msgs</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
</span><span id="__span-4-17"><a id="__codelineno-4-17" name="__codelineno-4-17" href="#__codelineno-4-17"></a><span class="n">msgs</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">buf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rbuf</span><span class="p">;</span>
</span><span id="__span-4-18"><a id="__codelineno-4-18" name="__codelineno-4-18" href="#__codelineno-4-18"></a>
</span><span id="__span-4-19"><a id="__codelineno-4-19" name="__codelineno-4-19" href="#__codelineno-4-19"></a><span class="n">fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">open</span><span class="p">(</span><span class="s">&quot;/dev/i2c-1&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">O_RDWR</span><span class="p">);</span>
</span><span id="__span-4-20"><a id="__codelineno-4-20" name="__codelineno-4-20" href="#__codelineno-4-20"></a><span class="c1">// ioctl para realizar las dos transacciones</span>
</span><span id="__span-4-21"><a id="__codelineno-4-21" name="__codelineno-4-21" href="#__codelineno-4-21"></a><span class="n">i2cdata</span><span class="p">.</span><span class="n">msgs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">msgs</span><span class="p">;</span>
</span><span id="__span-4-22"><a id="__codelineno-4-22" name="__codelineno-4-22" href="#__codelineno-4-22"></a><span class="n">i2cdata</span><span class="p">.</span><span class="n">nmsgs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
</span><span id="__span-4-23"><a id="__codelineno-4-23" name="__codelineno-4-23" href="#__codelineno-4-23"></a><span class="n">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="n">I2C_RDWR</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">i2cdata</span><span class="p">);</span><span class="w"> </span><span class="c1">// Operaciones encadenadas</span>
</span></code></pre></div>
<h3 id="ejemplo-de-transaccion-smbus">Ejemplo de transacción SMBus<a class="headerlink" href="#ejemplo-de-transaccion-smbus" title="Permanent link">&para;</a></h3>
<p>La misma lectura de un registro de tamaño byte usando el API SMBus se realizaría
del siguiente modo:</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="kt">int</span><span class="w"> </span><span class="n">addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x68</span><span class="p">;</span><span class="w">              </span><span class="c1">// Dirección del sensor I2C</span>
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a><span class="kt">unsigned</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">regid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x1b</span><span class="p">;</span><span class="w">   </span><span class="c1">// Id del registro a leer</span>
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a><span class="kt">unsigned</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">buf</span><span class="p">;</span><span class="w">            </span><span class="c1">// buffer para el valor leído</span>
</span><span id="__span-5-4"><a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a><span class="kt">int</span><span class="w"> </span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>
</span><span id="__span-5-5"><a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a>
</span><span id="__span-5-6"><a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a><span class="n">fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">open</span><span class="p">(</span><span class="s">&quot;/dev/i2c-1&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">O_RDWR</span><span class="p">);</span>
</span><span id="__span-5-7"><a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a><span class="n">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="n">I2C_SLAVE</span><span class="p">,</span><span class="w"> </span><span class="n">addr</span><span class="p">);</span>
</span><span id="__span-5-8"><a id="__codelineno-5-8" name="__codelineno-5-8" href="#__codelineno-5-8"></a>
</span><span id="__span-5-9"><a id="__codelineno-5-9" name="__codelineno-5-9" href="#__codelineno-5-9"></a><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i2c_smbus_read_byte_data</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="n">regid</span><span class="p">);</span>
</span><span id="__span-5-10"><a id="__codelineno-5-10" name="__codelineno-5-10" href="#__codelineno-5-10"></a><span class="n">buf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>
</span></code></pre></div>
<h2 id="ejemplo-lectura-del-sensor-inertial-one">Ejemplo: lectura del sensor Inertial One<a class="headerlink" href="#ejemplo-lectura-del-sensor-inertial-one" title="Permanent link">&para;</a></h2>
<p>La placa <a href="https://ww1.microchip.com/downloads/en/Appnotes/doc8354.pdf">Inertial One
ATAVRSBIN1</a>
contiene 3 dispositivos i2c:</p>
<ul>
<li>Acelerómetro de tres ejes Bosh Sensortech (BMA-150)</li>
<li>Giróscopo de tres ejes InvenSense (ITG-3200)</li>
<li>Brújula Electrónica de tres ejes AKM (AK8975)</li>
</ul>
<p>Podemos conectarla a la placa BEE del siguiente modo:</p>
<ul>
<li>Pin 1 del Jumper J2 a SDA</li>
<li>Pin 2 del Jumper J2 a SCL</li>
<li>Pin 9 del Jumper J2 a Gnd</li>
<li>Pin 10 del Jumper J2 a Vdd</li>
</ul>
<p>Para comprobar que está bien conectada podemos usar el comando <em>i2cdetect -y 1</em>:</p>
<div class="language-sh highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a>pi@raspberrypi:~/ejemplos<span class="w"> </span>$<span class="w"> </span>i2cdetect<span class="w"> </span>-y<span class="w"> </span><span class="m">1</span>
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a><span class="w">     </span><span class="m">0</span><span class="w">  </span><span class="m">1</span><span class="w">  </span><span class="m">2</span><span class="w">  </span><span class="m">3</span><span class="w">  </span><span class="m">4</span><span class="w">  </span><span class="m">5</span><span class="w">  </span><span class="m">6</span><span class="w">  </span><span class="m">7</span><span class="w">  </span><span class="m">8</span><span class="w">  </span><span class="m">9</span><span class="w">  </span>a<span class="w">  </span>b<span class="w">  </span>c<span class="w">  </span>d<span class="w">  </span>e<span class="w">  </span>f
</span><span id="__span-6-3"><a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a><span class="m">00</span>:<span class="w">                         </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>0c<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--
</span><span id="__span-6-4"><a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a><span class="m">10</span>:<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--
</span><span id="__span-6-5"><a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a><span class="m">20</span>:<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--
</span><span id="__span-6-6"><a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a><span class="m">30</span>:<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span><span class="m">38</span><span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--
</span><span id="__span-6-7"><a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a><span class="m">40</span>:<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--
</span><span id="__span-6-8"><a id="__codelineno-6-8" name="__codelineno-6-8" href="#__codelineno-6-8"></a><span class="m">50</span>:<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--
</span><span id="__span-6-9"><a id="__codelineno-6-9" name="__codelineno-6-9" href="#__codelineno-6-9"></a><span class="m">60</span>:<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span><span class="m">68</span><span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--
</span><span id="__span-6-10"><a id="__codelineno-6-10" name="__codelineno-6-10" href="#__codelineno-6-10"></a><span class="m">70</span>:<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--
</span><span id="__span-6-11"><a id="__codelineno-6-11" name="__codelineno-6-11" href="#__codelineno-6-11"></a>pi@raspberrypi:~/ejemplos<span class="w"> </span>$
</span></code></pre></div>
<p>El Giróscopo ITG-3200 del Inertial One tiene asignada la dirección 0x68, e
integra cuatro sensores de 16 bits accesibles en los siguientes registros:</p>
<p><img alt="ITG-3200" src="fig/itg-3200-sensor-regs.png" /></p>
<p>Como puede verse, cada sensor tiene dos registros, uno con los 8 bits más
significativos y otro con los 8 bits menos significativos. El programa de
ejemplo <a href="src/itg3200_sensors.c">itg3200_sensors.c</a> lee estos sensores y muestra
su valor por la salida estándar. Los flags de la línea de comandos permiten
seleccionar los tres tipos de transacciones para leer estos valores. Examina el
programa y prueba a utilizarlo leyendo cada uno de los registros. Comprueba que
funcionan los tres tipos de transacciones.</p>
<h3 id="ejercicio">Ejercicio<a class="headerlink" href="#ejercicio" title="Permanent link">&para;</a></h3>
<p>Diseñar un programa que lea los valores <em>acc_x</em>, <em>acc_y</em> y <em>acc_z</em> del
acelerómetro BMA 150 incluido en la unidad inercial. Consultar el
<a href="https://www.tomark.co.uk/wp-content/uploads/2021/05/BMA150.pdf">datasheet</a> del
componente para:</p>
<ul>
<li>Determinar los registros que hay que leer</li>
<li>Determinar el registro de configuración del:<ul>
<li>rango de medida, seleccionar el rango [-2g, 2g)</li>
<li>el ancho de banda, seleccionar 25 Hz</li>
</ul>
</li>
<li>Determinar la sensibilidad de la medida</li>
</ul>
<p>Consultar el[Application Note de NXP <a href="https://www.nxp.com/files-static/sensors/doc/app_note/AN3461.pdf">Tilt Sensing Using a Three-Axis
Accelerometer
(AN3461)</a> para
determinar cómo obtener los ángulos <em>roll</em> y <em>pitch</em> a partir de las medidas del
acelerómetro.</p>

              
            </article>
          </div>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Footer">
      
        
        <a href="../spi_linux/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Control de dispositivos SPI" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Control de dispositivos SPI
            </div>
          </div>
        </a>
      
      
        
        <a href="../control_servomotores/" class="md-footer__link md-footer__link--next" aria-label="Next: Control de servomotores con PWM" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              Control de servomotores con PWM
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "..", "features": ["toc.integrate"], "search": "../assets/javascripts/workers/search.bd0b6b67.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.467223ff.min.js"></script>
      
        <script src="../javascripts/mathjax.js"></script>
      
        <script src="https://unpkg.com/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>