
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.4.2, mkdocs-material-8.2.5">
    
    
      
        <title>Control GPIO en Linux - BEE Docs</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.2d9f7617.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.e6a45f82.min.css">
        
      
    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#control-gpio-en-linux" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="BEE Docs" class="md-header__button md-logo" aria-label="BEE Docs" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            BEE Docs
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Control GPIO en Linux
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  

<nav class="md-nav md-nav--primary md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="BEE Docs" class="md-nav__button md-logo" aria-label="BEE Docs" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    BEE Docs
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_1" type="checkbox" id="__nav_1" >
      
      
      
      
        <label class="md-nav__link" for="__nav_1">
          Documentación Técnica
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Documentación Técnica" data-md-level="1">
        <label class="md-nav__title" for="__nav_1">
          <span class="md-nav__icon md-icon"></span>
          Documentación Técnica
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        Placa de expansión BEE
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_2">
          Prácticas
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Prácticas" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Prácticas
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Control GPIO en Linux
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Control GPIO en Linux
      </a>
      
        

  

<nav class="md-nav md-nav--secondary" aria-label="On this page">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      On this page
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#introduccion" class="md-nav__link">
    Introducción
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#utilidades-de-linea-de-comandos" class="md-nav__link">
    Utilidades de línea de comandos
  </a>
  
    <nav class="md-nav" aria-label="Utilidades de línea de comandos">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#gpiodetect" class="md-nav__link">
    gpiodetect
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#gpioinfo" class="md-nav__link">
    gpioinfo
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#gpiofind" class="md-nav__link">
    gpiofind
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#gpioset" class="md-nav__link">
    gpioset
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#gpioget" class="md-nav__link">
    gpioget
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#gpiomon" class="md-nav__link">
    gpiomon
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#driver-gpio" class="md-nav__link">
    Driver GPIO
  </a>
  
    <nav class="md-nav" aria-label="Driver GPIO">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#operaciones-ioctl" class="md-nav__link">
    Operaciones ioctl
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#obtener-informacion-del-controlador-gpio" class="md-nav__link">
    Obtener información del controlador GPIO
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pines-de-entrada-y-salida" class="md-nav__link">
    Pines de entrada y salida
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#eventos-en-pines-de-entrada" class="md-nav__link">
    Eventos en pines de entrada
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#gpio-mapeado-en-memoria" class="md-nav__link">
    GPIO mapeado en memoria
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../pwm_linux/" class="md-nav__link">
        Control PWM en Linux
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../spi_linux/" class="md-nav__link">
        Control de dispositivos SPI
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../i2c_linux/" class="md-nav__link">
        Control de dispositivos I2C
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../control_servomotores/" class="md-nav__link">
        Control de servomotores con PWM
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../robotica/" class="md-nav__link">
        Prácticas de Robótica
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../linux-kernel/config/" class="md-nav__link">
        Drivers en Linux. Preparación del entorno de trabajo
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../linux-kernel/drivers/" class="md-nav__link">
        Drivers en Linux. Aspectos básicos y GPIO
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../linux-kernel/sincronizacion/" class="md-nav__link">
        Drivers en Linux. Sincronización en el kernel
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../linux-kernel/interrupt-timers-pwm/" class="md-nav__link">
        Drivers en Linux. Gestión de interrupciones, temporizadores, y trabajos diferidos
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                


<h1 id="control-gpio-en-linux">Control GPIO en Linux<a class="headerlink" href="#control-gpio-en-linux" title="Permanent link">&para;</a></h1>
<p>En esta práctica utilizaremos los drivers que proporciona linux para controlar
el GPIO. Puedes hacer esta práctica si tienes una raspberry-pi con Raspbian,
consiguiendo manejar dispositivos sencillos, como los pulsadores y los leds que
incorpora la placa BEE, desde un programa de usuario escrito en C.</p>
<h2 id="introduccion">Introducción<a class="headerlink" href="#introduccion" title="Permanent link">&para;</a></h2>
<p>Linux expone los controladores del GPIO como dispositivos orientados a
caracteres <em>/dev/gpiochip#</em>. Usar estos dispositivos ofrece las siguientes
ventajas:</p>
<ul>
<li>Portabilidad: el código es prácticamente independiente del hardware, a
  excepción de los GPIOS/pines que hay que usar</li>
<li>No requiere privilegios de root</li>
<li>Ofrece un mecanismo para tratar eventos hw desde el espacio de usuario</li>
<li>Mantiene la semántica UNIX tradicional de <em>todo es un fichero</em></li>
</ul>
<p>Como con cualquier otro dispositivo, podemos trabajar con el gpio como si fuese
un fichero, utilizando las llamadas al sistema <em>open()</em>, <em>read()</em>, <em>write()</em>,
<em>ioctl()</em>, <em>close()</em>.</p>
<p>En esta práctica usaremos la versión 2 del ABI, la 1 se considera obsoleta
(<em>deprecated</em>). La fuente más fiable de referencia/documentación es el propio
fichero de cabecera <em>/usr/include/linux/gpio.h</em>.</p>
<h2 id="utilidades-de-linea-de-comandos">Utilidades de línea de comandos<a class="headerlink" href="#utilidades-de-linea-de-comandos" title="Permanent link">&para;</a></h2>
<p>La librería libgpiod nos ofrece unos programas de ejemplo que podemos utilizar
como utilidades de línea de comandos para interactuar con los controladores de
GPIO.</p>
<p>Para disponer de estas herramientas debemos instalar algunos paquetes de
raspbian:</p>
<div class="language-sh highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a>sudo<span class="w"> </span>apt<span class="w"> </span>install<span class="w"> </span>gpiod<span class="w"> </span>libgpiod-dev<span class="w"> </span>libgpiod-doc
</span></code></pre></div>
<p>Una vez instalados estos paquetes tendremos disponibles las utilidades
descritas en las siguientes secciones.</p>
<h3 id="gpiodetect">gpiodetect<a class="headerlink" href="#gpiodetect" title="Permanent link">&para;</a></h3>
<p>Esta utilidad nos da una lista de los dispositivos de caracteres para control
del gpio disponibles en nuestra plataforma:</p>
<div class="language-sh highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a>pi@raspberrypi:~<span class="w"> </span>$<span class="w"> </span>gpiodetect
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a>gpiochip0<span class="w"> </span><span class="o">[</span>pinctrl-bcm2835<span class="o">]</span><span class="w"> </span><span class="o">(</span><span class="m">54</span><span class="w"> </span>lines<span class="o">)</span>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a>gpiochip1<span class="w"> </span><span class="o">[</span>brcmvirt-gpio<span class="o">]</span><span class="w"> </span><span class="o">(</span><span class="m">2</span><span class="w"> </span>lines<span class="o">)</span>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a>gpiochip2<span class="w"> </span><span class="o">[</span>raspberrypi-exp-gpio<span class="o">]</span><span class="w"> </span><span class="o">(</span><span class="m">8</span><span class="w"> </span>lines<span class="o">)</span>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a>pi@raspberrypi:~<span class="w"> </span>$
</span></code></pre></div>
<h3 id="gpioinfo">gpioinfo<a class="headerlink" href="#gpioinfo" title="Permanent link">&para;</a></h3>
<p>Esta utilidad lista los pines controlados por uno de los controladores:</p>
<div class="language-sh highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a>pi@raspberrypi:~<span class="w"> </span>$<span class="w"> </span>gpioinfo<span class="w"> </span>gpiochip0
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a>gpiochip0<span class="w"> </span>-<span class="w"> </span><span class="m">54</span><span class="w"> </span>lines:
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a><span class="w">    </span>line<span class="w">   </span><span class="m">0</span>:<span class="w">      </span>unnamed<span class="w">       </span>unused<span class="w">   </span>input<span class="w">  </span>active-high
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a><span class="w">    </span>line<span class="w">   </span><span class="m">1</span>:<span class="w">      </span>unnamed<span class="w">       </span>unused<span class="w">   </span>input<span class="w">  </span>active-high
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a><span class="w">    </span>line<span class="w">   </span><span class="m">2</span>:<span class="w">      </span>unnamed<span class="w">       </span>unused<span class="w">   </span>input<span class="w">  </span>active-high
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a><span class="w">    </span>line<span class="w">   </span><span class="m">3</span>:<span class="w">      </span>unnamed<span class="w">       </span>unused<span class="w">   </span>input<span class="w">  </span>active-high
</span><span id="__span-2-7"><a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a><span class="w">    </span>...
</span><span id="__span-2-8"><a id="__codelineno-2-8" name="__codelineno-2-8" href="#__codelineno-2-8"></a>pi@raspberrypi:~<span class="w"> </span>$
</span></code></pre></div>
<h3 id="gpiofind">gpiofind<a class="headerlink" href="#gpiofind" title="Permanent link">&para;</a></h3>
<p>Utilidad que nos da el número de línea de gpio para líneas identificadas con un
  nombre en el <em>device-tree</em></p>
<h3 id="gpioset">gpioset<a class="headerlink" href="#gpioset" title="Permanent link">&para;</a></h3>
<p>Utilidad que permite asignar un valor a un conjunto de líneas del gpio mientras
ejecuta el comando. Con <em>-m modo</em> podemos configurar lo que hace el comando tras
dar el valor a las líneas. Los posibles modos son:</p>
<ul>
<li>wait: espera a que el usuario pulse enter</li>
<li>exit: termina inmediatamente</li>
<li>time: duerme por el periodo de tiempo especificado con el flag -s o el flag -u</li>
<li>signal: espera hasta recibir SIGINT o SIGTERM</li>
</ul>
<p>Por ejemplo, para encender 3 leds conectados a los pines 20, 21 y 26, 
hasta que el usuario pulse enter:</p>
<div class="language-sh highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a>pi@raspberrypi:~<span class="w"> </span>$<span class="w"> </span>gpioset<span class="w"> </span>-m<span class="w"> </span><span class="nb">wait</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="nv">20</span><span class="o">=</span><span class="m">1</span><span class="w"> </span><span class="nv">21</span><span class="o">=</span><span class="m">1</span><span class="w"> </span><span class="nv">26</span><span class="o">=</span><span class="m">1</span>
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a>pi@raspberrypi:~<span class="w"> </span>$
</span></code></pre></div>
<p>El siguiente script es un ejemplo de uso de gpioset que hace oscilar una luz
entre tres leds.</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="ch">#!/bin/bash</span>
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a>
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a><span class="nv">ini</span><span class="o">=</span>0x01
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a><span class="nv">dir</span><span class="o">=</span><span class="m">0</span>
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a><span class="k">while</span><span class="w"> </span><span class="nb">true</span>
</span><span id="__span-4-6"><a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a><span class="k">do</span>
</span><span id="__span-4-7"><a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a><span class="w">    </span><span class="nv">bit26</span><span class="o">=</span><span class="k">$((</span><span class="w"> </span><span class="o">(</span>ini<span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="m">0</span>x4<span class="o">)</span><span class="w"> </span>&gt;&gt;<span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="k">))</span>
</span><span id="__span-4-8"><a id="__codelineno-4-8" name="__codelineno-4-8" href="#__codelineno-4-8"></a><span class="w">    </span><span class="nv">bit21</span><span class="o">=</span><span class="k">$((</span><span class="w"> </span><span class="o">(</span>ini<span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="m">0</span>x2<span class="o">)</span><span class="w"> </span>&gt;&gt;<span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="k">))</span>
</span><span id="__span-4-9"><a id="__codelineno-4-9" name="__codelineno-4-9" href="#__codelineno-4-9"></a><span class="w">    </span><span class="nv">bit20</span><span class="o">=</span><span class="k">$((</span>ini<span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="m">0</span>x1<span class="k">))</span>
</span><span id="__span-4-10"><a id="__codelineno-4-10" name="__codelineno-4-10" href="#__codelineno-4-10"></a><span class="w">    </span>gpioset<span class="w"> </span>-m<span class="w"> </span><span class="nb">time</span><span class="w"> </span>-s<span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="nv">26</span><span class="o">=</span><span class="nv">$bit26</span><span class="w"> </span><span class="nv">21</span><span class="o">=</span><span class="nv">$bit21</span><span class="w"> </span><span class="nv">20</span><span class="o">=</span><span class="nv">$bit20</span>
</span><span id="__span-4-11"><a id="__codelineno-4-11" name="__codelineno-4-11" href="#__codelineno-4-11"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="nv">$dir</span><span class="w"> </span>-eq<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
</span><span id="__span-4-12"><a id="__codelineno-4-12" name="__codelineno-4-12" href="#__codelineno-4-12"></a><span class="w">        </span><span class="nv">ini</span><span class="o">=</span><span class="k">$((</span><span class="o">(</span>ini<span class="w"> </span><span class="s">&lt;&lt; 1) &amp; 0x7))</span>
</span><span id="__span-4-13"><a id="__codelineno-4-13" name="__codelineno-4-13" href="#__codelineno-4-13"></a><span class="s">    else</span>
</span><span id="__span-4-14"><a id="__codelineno-4-14" name="__codelineno-4-14" href="#__codelineno-4-14"></a><span class="s">        ini=$(((ini &gt;&gt; 1</span><span class="o">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="m">0</span>x7<span class="k">))</span>
</span><span id="__span-4-15"><a id="__codelineno-4-15" name="__codelineno-4-15" href="#__codelineno-4-15"></a><span class="w">    </span><span class="k">fi</span>
</span><span id="__span-4-16"><a id="__codelineno-4-16" name="__codelineno-4-16" href="#__codelineno-4-16"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="nv">$ini</span><span class="w"> </span>-eq<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
</span><span id="__span-4-17"><a id="__codelineno-4-17" name="__codelineno-4-17" href="#__codelineno-4-17"></a><span class="w">        </span><span class="nv">dir</span><span class="o">=</span><span class="k">$((</span><span class="o">(</span>dir<span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">1</span><span class="o">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="m">1</span><span class="k">))</span>
</span><span id="__span-4-18"><a id="__codelineno-4-18" name="__codelineno-4-18" href="#__codelineno-4-18"></a><span class="w">        </span><span class="nv">ini</span><span class="o">=</span>0x2
</span><span id="__span-4-19"><a id="__codelineno-4-19" name="__codelineno-4-19" href="#__codelineno-4-19"></a><span class="w">    </span><span class="k">fi</span>
</span><span id="__span-4-20"><a id="__codelineno-4-20" name="__codelineno-4-20" href="#__codelineno-4-20"></a><span class="k">done</span>
</span></code></pre></div>
<h3 id="gpioget">gpioget<a class="headerlink" href="#gpioget" title="Permanent link">&para;</a></h3>
<p>Esta utilidad nos da el estado actual de las líneas solicitadas en el chip de
control indicado en la linea de comandos</p>
<h3 id="gpiomon">gpiomon<a class="headerlink" href="#gpiomon" title="Permanent link">&para;</a></h3>
<p>Esta utilidad nos permite monitorizar el estado de unos pines. Usa la llamada al
sistema <em>poll</em>, con las siguientes opciones:</p>
<ul>
<li>-n NUM: termina después de \texttt{NUM} eventos</li>
<li>-s: no imprime información de evento</li>
<li>-r: procesa sólo eventos de flanco de subida</li>
<li>-f: procesa sólo eventos de flanco de bajada</li>
<li>-F FMT: especifica el formato de salida (consulta la página de manual)</li>
</ul>
<p>Por ejemplo, para monitorizar tres pulsadores conectados a las líneas 19, 6 y 5:</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a>pi@raspberrypi:~<span class="w"> </span>$<span class="w"> </span>gpiomon<span class="w"> </span>-f<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">19</span><span class="w"> </span><span class="m">6</span><span class="w"> </span><span class="m">5</span>
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a>event:<span class="w"> </span>FALLING<span class="w"> </span>EDGE<span class="w"> </span>offset:<span class="w"> </span><span class="m">19</span><span class="w"> </span>timestamp:<span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="m">2740</span>.887807571<span class="o">]</span>
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a>event:<span class="w"> </span>FALLING<span class="w"> </span>EDGE<span class="w"> </span>offset:<span class="w"> </span><span class="m">6</span><span class="w"> </span>timestamp:<span class="w"> </span><span class="o">[</span><span class="w">  </span><span class="m">2742</span>.291116096<span class="o">]</span>
</span><span id="__span-5-4"><a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a>event:<span class="w"> </span>FALLING<span class="w"> </span>EDGE<span class="w"> </span>offset:<span class="w"> </span><span class="m">5</span><span class="w"> </span>timestamp:<span class="w"> </span><span class="o">[</span><span class="w">  </span><span class="m">2744</span>.609921761<span class="o">]</span>
</span><span id="__span-5-5"><a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a>^Cpi@raspberrypi:~<span class="w"> </span>$
</span></code></pre></div>
<h2 id="driver-gpio">Driver GPIO<a class="headerlink" href="#driver-gpio" title="Permanent link">&para;</a></h2>
<p>Vamos a ver cómo podemos manejar los pines del GPIO desde un programa de usuario
escrito en C utilizando el driver de GPIO proporcionado por Linux. Para ello
debemos comprender qué son las operaciones ioctl en el estándar POSIX, que serán
vitales para la comunicación con el driver. Luego iremos viendo como podemos
utilizar estas operaciones para interactuar con el controlador GPIO.</p>
<h3 id="operaciones-ioctl">Operaciones ioctl<a class="headerlink" href="#operaciones-ioctl" title="Permanent link">&para;</a></h3>
<p>En los sistemas POSIX las operaciones sobre un dispositivo que no sean read o 
write se realizan con la llamada al sistema <em>ioctl</em>, cuyo prototipo es:</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="kt">int</span><span class="w"> </span><span class="nf">ioctl</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">request</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">argp</span><span class="p">);</span>
</span></code></pre></div>
<p>dónde:</p>
<ul>
<li><em>fd</em>: descriptor de fichero devuelto por open</li>
<li><em>request</em>: petición de operación, dependiente del dispositivo.</li>
<li><em>argp</em>: dirección a un buffer que depende del tipo de operación.</li>
</ul>
<p>No hay un estándar para los códigos de las peticiones, pero un convenio que es
ampliamente usado es el siguiente:</p>
<ul>
<li>Dos bits para indicar la dirección: 00 (nada),  01 (lectura), 10 (escritura) y
  11 (lectura y escritura).</li>
<li>14 bits que indican el tamaño del dato pasado como argumento</li>
<li>8 bits de tipo de operación</li>
<li>8 bits de número de operación</li>
</ul>
<p>El sistema define unas macros para ayudar a la codificación de estas peticiones:
_IOR(type, nr, arg), _IOW(type, nr, arg), _IOWR(type, nr, arg) e _IO(type, nr).</p>
<h3 id="obtener-informacion-del-controlador-gpio">Obtener información del controlador GPIO<a class="headerlink" href="#obtener-informacion-del-controlador-gpio" title="Permanent link">&para;</a></h3>
<p>Para obtener información del controlador podemos utilizar la petición <em>ioctl</em>
GPIO_GET_CHIP_INFO, que requiere como parámetro adicional la dirección de una
estructura del siguiente tipo:</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">gpiochip_info</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a><span class="w">  </span><span class="kt">char</span><span class="w"> </span><span class="n">name</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span><span class="w">    </span><span class="cm">/* Nombre del controlador en el kernel */</span>
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a><span class="w">  </span><span class="kt">char</span><span class="w"> </span><span class="n">label</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span><span class="w">   </span><span class="cm">/* Nombre funcional, de producto */</span>
</span><span id="__span-7-4"><a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a><span class="w">  </span><span class="n">__u32</span><span class="w"> </span><span class="n">lines</span><span class="p">;</span><span class="w">      </span><span class="cm">/* número de líneas que maneja */</span>
</span><span id="__span-7-5"><a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a><span class="p">};</span>
</span></code></pre></div>
<p>Un ejemplo de uso sería el siguiente:</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="kt">int</span><span class="w"> </span><span class="n">fd</span><span class="p">;</span>
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a><span class="k">struct</span><span class="w"> </span><span class="nc">gpiochip_info</span><span class="w"> </span><span class="n">info</span><span class="p">;</span>
</span><span id="__span-8-3"><a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a><span class="n">fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">open</span><span class="p">(</span><span class="s">&quot;/dev/gpiochip0&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">O_RDONLY</span><span class="p">);</span>
</span><span id="__span-8-4"><a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a><span class="n">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="n">GPIO_GET_CHIPINFO_IOCTL</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">info</span><span class="p">);</span>
</span><span id="__span-8-5"><a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a><span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
</span><span id="__span-8-6"><a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a><span class="n">printf</span><span class="p">(</span><span class="s">&quot;label: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">info</span><span class="p">.</span><span class="n">label</span><span class="p">);</span>
</span><span id="__span-8-7"><a id="__codelineno-8-7" name="__codelineno-8-7" href="#__codelineno-8-7"></a><span class="n">printf</span><span class="p">(</span><span class="s">&quot;name: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">info</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
</span><span id="__span-8-8"><a id="__codelineno-8-8" name="__codelineno-8-8" href="#__codelineno-8-8"></a><span class="n">printf</span><span class="p">(</span><span class="s">&quot;number of lines: %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">info</span><span class="p">.</span><span class="n">lines</span><span class="p">);</span>
</span></code></pre></div>
<p>Examinar el ejemplo <a href="src/gpio_info.c">gpio_info</a> y comprobar su funcionamiento.</p>
<h3 id="pines-de-entrada-y-salida">Pines de entrada y salida<a class="headerlink" href="#pines-de-entrada-y-salida" title="Permanent link">&para;</a></h3>
<p>El driver de GPIO nos permite agrupar pines en <em>líneas</em>, que pueden recibir un
nombre lógico definido por el programador(por ejemplo sevenseg). Para crear una
de estas <em>líneas de pines</em>, una vez abierto el dispositivo, debemos hacer una
petición ioctl de tipo <em>line_request</em>:</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">gpio_v2_line_request</span><span class="w"> </span><span class="n">req</span><span class="p">;</span>
</span><span id="__span-9-2"><a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a>
</span><span id="__span-9-3"><a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a><span class="n">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="n">GPIO_V2_GET_LINE_IOCTL</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">req</span><span class="p">);</span>
</span></code></pre></div>
<p>El registro <em>req</em> tiene la siguiente estructura: </p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">gpio_v2_line_request</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-10-2"><a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a><span class="w">    </span><span class="n">__u32</span><span class="w"> </span><span class="n">offsets</span><span class="p">[</span><span class="n">GPIO_V2_LINES_MAX</span><span class="p">];</span><span class="w">  </span><span class="c1">//pines a manejar      (in)</span>
</span><span id="__span-10-3"><a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a><span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">consumer</span><span class="p">[</span><span class="n">GPIO_MAX_NAME_SIZE</span><span class="p">];</span><span class="w"> </span><span class="c1">//nombre por usuario   (in)</span>
</span><span id="__span-10-4"><a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">gpio_v2_line_config</span><span class="w"> </span><span class="n">config</span><span class="p">;</span><span class="w"> </span><span class="c1">//configuración        (in)</span>
</span><span id="__span-10-5"><a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a><span class="w">    </span><span class="n">__u32</span><span class="w"> </span><span class="n">num_lines</span><span class="p">;</span><span class="w">                   </span><span class="c1">//num pines en offsets (in)</span>
</span><span id="__span-10-6"><a id="__codelineno-10-6" name="__codelineno-10-6" href="#__codelineno-10-6"></a><span class="w">    </span><span class="n">__u32</span><span class="w"> </span><span class="n">event_buffer_size</span><span class="p">;</span><span class="w">           </span><span class="c1">//para eventos         (in)</span>
</span><span id="__span-10-7"><a id="__codelineno-10-7" name="__codelineno-10-7" href="#__codelineno-10-7"></a><span class="w">    </span><span class="n">__u32</span><span class="w"> </span><span class="n">padding</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span><span class="w">                  </span><span class="c1">//no usado</span>
</span><span id="__span-10-8"><a id="__codelineno-10-8" name="__codelineno-10-8" href="#__codelineno-10-8"></a><span class="w">    </span><span class="n">__s32</span><span class="w"> </span><span class="n">fd</span><span class="p">;</span><span class="w">                          </span><span class="c1">//fd de salida         (out)</span>
</span><span id="__span-10-9"><a id="__codelineno-10-9" name="__codelineno-10-9" href="#__codelineno-10-9"></a><span class="p">};</span>
</span></code></pre></div>
<p>El campo <em>offsets</em> debe contener los números de los pines que pertenecen a la
línea, indicando el número total de pines de la línea en <em>num_lines</em>. El campo
<em>config</em> se utiliza para indicar la configuración de cada uno de los pines que
pertenecen a la línea. El campo <em>fd</em> es de salida, en el retorno de la llamada
ioctl contendrá un nuevo descriptor de fichero que podemos usar para operar
sobre los pines de la línea (leer, escribir, etc).</p>
<p>El campo <em>config</em> tiene la siguiente estructura:</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">gpio_v2_line_config</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-11-2"><a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a><span class="w">    </span><span class="n">__aligned_u64</span><span class="w"> </span><span class="n">flags</span><span class="p">;</span><span class="w"> </span><span class="c1">// flags por defecto para los pines</span>
</span><span id="__span-11-3"><a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a><span class="w">    </span><span class="n">__u32</span><span class="w"> </span><span class="n">num_attrs</span><span class="p">;</span><span class="w">     </span><span class="c1">// número de atributos en attrs</span>
</span><span id="__span-11-4"><a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a><span class="w">    </span><span class="n">__u32</span><span class="w"> </span><span class="n">padding</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span><span class="w">    </span><span class="c1">// no usado</span>
</span><span id="__span-11-5"><a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">gpio_v2_line_config_attribute</span>
</span><span id="__span-11-6"><a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a><span class="w">     </span><span class="n">attrs</span><span class="p">[</span><span class="n">GPIO_V2_LINE_NUM_ATTRS_MAX</span><span class="p">];</span><span class="w"> </span><span class="c1">// array de atributos</span>
</span><span id="__span-11-7"><a id="__codelineno-11-7" name="__codelineno-11-7" href="#__codelineno-11-7"></a><span class="p">};</span>
</span></code></pre></div>
<p>El campo <em>flags</em> permite establecer una configuración por defecto para los pines
de la línes. Se trata de una máscara de bits a la que se le debe asignar una
combinación, con or a nivel de bit (operadores <em>bitwise</em>), de las siguientes
macros:</p>
<ul>
<li><code>GPIO_V2_LINE_FLAG_USED</code></li>
<li><code>GPIO_V2_LINE_FLAG_ACTIVE_LOW</code></li>
<li><code>GPIO_V2_LINE_FLAG_INPUT</code></li>
<li><code>GPIO_V2_LINE_FLAG_OUTPUT</code></li>
<li><code>GPIO_V2_LINE_FLAG_EDGE_RISING</code></li>
<li><code>GPIO_V2_LINE_FLAG_EDGE_FALLING</code></li>
<li><code>GPIO_V2_LINE_FLAG_OPEN_DRAIN</code></li>
<li><code>GPIO_V2_LINE_FLAG_OPEN_SOURCE</code></li>
<li><code>GPIO_V2_LINE_FLAG_BIAS_PULL_UP</code></li>
<li><code>GPIO_V2_LINE_FLAG_BIAS_PULL_DOWN</code></li>
<li><code>GPIO_V2_LINE_FLAG_BIAS_DISABLED</code></li>
</ul>
<p>Los atributos de la línea nos permiten cambiar la configuración de un
subconjunto de los pines de la línea o indicar información complementaria a los
flags necesaria para completar su configuración (por ejemplo valor del pin en
pines de salida). El campo <em>attrs</em> es un array de atributos definidos para la
línea, indicando el número de atributos definidos en el campo <em>num_attrs</em>. Cada
atributo se define con la siguiente estructura:</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">gpio_v2_line_config_attribute</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-12-2"><a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">gpio_v2_line_attribute</span><span class="w"> </span><span class="n">attr</span><span class="p">;</span><span class="w"> </span><span class="c1">//atributo</span>
</span><span id="__span-12-3"><a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a><span class="w">    </span><span class="n">__aligned_u64</span><span class="w"> </span><span class="n">mask</span><span class="p">;</span><span class="w">                 </span><span class="c1">//pines a los que aplica</span>
</span><span id="__span-12-4"><a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a><span class="p">};</span>
</span></code></pre></div>
<p>El campo <em>mask</em> indica los pines de la linea afectados por el atributo, dónde
cada bit corresponde a un índice del array de offsets de la estructura 
<em>struct gpio_v2_line_request</em>. El campo <em>attr</em> se representa con la siguiente
estructura:</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">gpio_v2_line_attribute</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-13-2"><a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a><span class="w">    </span><span class="n">__u32</span><span class="w"> </span><span class="n">id</span><span class="p">;</span><span class="w"> </span><span class="c1">//GPIO_V2_LINE_ATTR_ID_{FLAGS,OUTPUT_VALUES,DEBOUNCE}</span>
</span><span id="__span-13-3"><a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a><span class="w">    </span><span class="n">__u32</span><span class="w"> </span><span class="n">padding</span><span class="p">;</span>
</span><span id="__span-13-4"><a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a><span class="w">    </span><span class="k">union</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-13-5"><a id="__codelineno-13-5" name="__codelineno-13-5" href="#__codelineno-13-5"></a><span class="w">        </span><span class="n">__aligned_u64</span><span class="w"> </span><span class="n">flags</span><span class="p">;</span><span class="w">     </span><span class="c1">// flag</span>
</span><span id="__span-13-6"><a id="__codelineno-13-6" name="__codelineno-13-6" href="#__codelineno-13-6"></a><span class="w">        </span><span class="n">__aligned_u64</span><span class="w"> </span><span class="n">values</span><span class="p">;</span><span class="w">    </span><span class="c1">// valor ini. 1-activo, 0-inactivo</span>
</span><span id="__span-13-7"><a id="__codelineno-13-7" name="__codelineno-13-7" href="#__codelineno-13-7"></a><span class="w">        </span><span class="n">__u32</span><span class="w"> </span><span class="n">debounce_period_us</span><span class="p">;</span><span class="c1">// tiempo de debounce</span>
</span><span id="__span-13-8"><a id="__codelineno-13-8" name="__codelineno-13-8" href="#__codelineno-13-8"></a><span class="w">    </span><span class="p">};</span>
</span><span id="__span-13-9"><a id="__codelineno-13-9" name="__codelineno-13-9" href="#__codelineno-13-9"></a><span class="p">};</span>
</span></code></pre></div>
<p>El campo <em>id</em> indica el tipo de atributo, y su valor determina el campo de la
unión que contiene la información correspondiente:</p>
<ul>
<li>
<p><em>GPIO_V2_LINE_ATTR_ID_FLAGS</em>: aplicable a cualquier grupo de pines. El campo
  <em>flags</em> de la unión indica una configuración alternativa para este grupo de
  pines.</p>
</li>
<li>
<p><em>GPIO_V2_LINE_ATTR_ID_OUTPUT</em>: aplicable a grupos de pines configurados como
  salida (por defecto o con atributos anteriores). El campo <em>values</em> de la unión
  indica el valor que se asigna a los pines afectados.</p>
</li>
<li>
<p><em>GPIO_V2_LINE_ATTR_ID_DEBOUNCE</em>: aplicable a pines configurados como entrada
  (por defecto o con atributos anteriores). El campo <em>debounce_period_us</em> de la
  unión indica el periodo en microsegundos con el que se muestrea el pin para
  eliminar rebotes (cualquier cambio más rápido es filtrado).</p>
</li>
</ul>
<p>Para leer o escribir en los pines de la línea debemos realizaremos nuevas
operaciones ioctl sobre el descriptor de fichero inicializado en la operación
ioctl <em>line_request</em>.</p>
<p>Para escribir un valor en pines configurados como salida usaremos la operación
ioctl <code>GPIO_V2_LINE_SET_VALUES_IOCTL</code>:</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">gpio_v2_line_values</span><span class="w"> </span><span class="n">values</span><span class="p">;</span>
</span><span id="__span-14-2"><a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a><span class="p">...</span>
</span><span id="__span-14-3"><a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a><span class="n">ioctl</span><span class="p">(</span><span class="n">req</span><span class="p">.</span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="n">GPIO_V2_LINE_SET_VALUES_IOCTL</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">values</span><span class="p">);</span>
</span></code></pre></div>
<p>mientras que para leer utilizaremos la operación <em>GPIO_V2_LINE_GET_VALUES_IOCTL</em>:</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-15-1"><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">gpio_v2_line_values</span><span class="w"> </span><span class="n">values</span><span class="p">;</span>
</span><span id="__span-15-2"><a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a><span class="p">...</span>
</span><span id="__span-15-3"><a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a><span class="n">ioctl</span><span class="p">(</span><span class="n">req</span><span class="p">.</span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="n">GPIO_V2_LINE_GET_VALUES_IOCTL</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">values</span><span class="p">);</span>
</span></code></pre></div>
<p>En ambos casos <em>values</em> tiene la siguiente estructura:</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-16-1"><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">gpio_v2_line_values</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-16-2"><a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a><span class="w">    </span><span class="n">__aligned_u64</span><span class="w"> </span><span class="n">bits</span><span class="p">;</span><span class="w"> </span><span class="c1">//máscara de bits con el valor los pines</span>
</span><span id="__span-16-3"><a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a><span class="w">    </span><span class="n">__aligned_u64</span><span class="w"> </span><span class="n">mask</span><span class="p">;</span><span class="w"> </span><span class="c1">//máscara de bits que leer/escribir</span>
</span><span id="__span-16-4"><a id="__codelineno-16-4" name="__codelineno-16-4" href="#__codelineno-16-4"></a><span class="p">};</span>
</span></code></pre></div>
<p>Cada bit de ambos campos se refiere a una de las posiciones del campo
<em>offsets</em> de la línea.</p>
<p>Veamos un ejemplo. El programa <a href="src/gpio_blink_v2.c">gpio_blink_v2.c</a> usa el
driver de caracteres del GPIO para hacer parpadear los leds que se indican por
la línea de comandos, con un periodo de 0.5Hz (1 s encendidos, 1 s apagados).
Podemos probar este programa en la raspberry, conectando tres pines a los tres
leds de la placa BEE.</p>
<p>Como ejercicio, se propone al estudiante modificar el código del programa
anterior para que de la sensación de que una luz va pasando de un led a otro,
dando la vuelta cuando llegue a los extremos.</p>
<h3 id="eventos-en-pines-de-entrada">Eventos en pines de entrada<a class="headerlink" href="#eventos-en-pines-de-entrada" title="Permanent link">&para;</a></h3>
<p>El driver del GPIO convierte las interrupciones en los pines del GPIO en eventos
software que se insertan en el descriptor de fichero (fd) asociado a la linea.
Esto permite:</p>
<ul>
<li>Usar programación multihilo, destiando un hilo a atender los eventos de
  entrada de la línea.</li>
<li>Usar mecanismos de multiplexación de entrada/salida para monitorizar varios
  descriptores/líneas (uando select, poll o epoll).</li>
</ul>
<p>La detección de eventos debe ser habilitada en los pines de entrada, añadiendo
uno los flags <code>GPIO_V2_LINE_FLAG_EDGE_RISING</code> y/o
<code>GPIO_V2_LINE_FLAG_EDGE_FALLING</code>. Además, se puede utilizar el atributo 
<code>GPIO_V2_LINE_ATTR_ID_DEBOUNCE</code> para configurar en el pin una eliminación de
rebotes.</p>
<p>Por cada evento podremos leer del descriptor de fichero una estructura del tipo:</p>
<p><div class="language-c highlight"><pre><span></span><code><span id="__span-17-1"><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">gpio_v2_line_event</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-17-2"><a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a><span class="w">    </span><span class="n">__aligned_u64</span><span class="w"> </span><span class="n">timestamp_ns</span><span class="p">;</span><span class="w"> </span><span class="c1">//Marca de tiempo del evento</span>
</span><span id="__span-17-3"><a id="__codelineno-17-3" name="__codelineno-17-3" href="#__codelineno-17-3"></a><span class="w">    </span><span class="n">__u32</span><span class="w"> </span><span class="n">id</span><span class="p">;</span><span class="w">                   </span><span class="c1">//Tipo de evento</span>
</span><span id="__span-17-4"><a id="__codelineno-17-4" name="__codelineno-17-4" href="#__codelineno-17-4"></a><span class="w">    </span><span class="n">__u32</span><span class="w"> </span><span class="n">offset</span><span class="p">;</span><span class="w">               </span><span class="c1">//offset del pin correspondiente</span>
</span><span id="__span-17-5"><a id="__codelineno-17-5" name="__codelineno-17-5" href="#__codelineno-17-5"></a><span class="w">    </span><span class="n">__u32</span><span class="w"> </span><span class="n">seqno</span><span class="p">;</span><span class="w">                </span><span class="c1">//núm. de secuencia global</span>
</span><span id="__span-17-6"><a id="__codelineno-17-6" name="__codelineno-17-6" href="#__codelineno-17-6"></a><span class="w">    </span><span class="n">__u32</span><span class="w"> </span><span class="n">line_seqno</span><span class="p">;</span><span class="w">           </span><span class="c1">//núm. de secuencia en este pin</span>
</span><span id="__span-17-7"><a id="__codelineno-17-7" name="__codelineno-17-7" href="#__codelineno-17-7"></a><span class="w">    </span><span class="n">__u32</span><span class="w"> </span><span class="n">padding</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span><span class="w">           </span><span class="c1">//reservado</span>
</span><span id="__span-17-8"><a id="__codelineno-17-8" name="__codelineno-17-8" href="#__codelineno-17-8"></a><span class="p">};</span>
</span></code></pre></div>
dónde el campo id nos identifica el evento detectado mientras que <em>offset</em>
identifica el pin en el que se producido el evento. El campo <em>seqno</em> nos indica
el órden global en el que el evento se ha detectado, mientras que <em>line_seqno</em>
nos indica el órden entre los eventos de la línea.</p>
<p>El programa de ejemplo <a href="src/gpio_toggle.c">gpio_toggle.c</a> usa el driver GPIO
para controlar el estado de unos leds con unos pulsadores. El programa recibe
como parámetros una lista con un número par de pines. La primera mitad se
configuran como pines entradas, activando la detección de eventos por flancos de
bajada, con un debounce de 10 ms. La segunda mitad se configuran como pines de
salida, inicialmente activos (a 1). El programa se queda esperando por eventos
de flanco de bajada en las entradas. Cuando se recibe un evento, se conmuta el
estado del pin de salida correspondiente. El programa puede probarse conectando
los 3 leds de la placa de expansión a 3 gpios (salidas) y los pulsadores a otros
3 gpios (entradas).</p>
<p>Como ejercicio se propone al estudiante modificar el programa para que los
pulsadores determinen si los leds parpadean o no. Es decir, inicialmente estarán
los 3 leds parpadeando a una frecuencia fija (por ejemplo 0.5 Hz), si se pulsa
uno de los pulsadores el led correspondiente se quedará apagado. Si se vuelve a
pulsar, el led volverá a parpadear síncronamente con el resto.</p>
<p>El dispositivo de caracteres GPIO soporta algunas operaciones ioctl adicionales:</p>
<ul>
<li>
<p><code>GPIO_V2_GET_LINEINFO_WATCH_IOCTL</code>, monitorizar cambios en un línea:</p>
<ul>
<li>Se pasa un argumento <code>struct gpio_v2_line_info</code></li>
<li>Se indican las líneas que se desean monitorizar</li>
<li>Los eventos de cambio se obtinen del <em>fd</em> del gpiochip correspondiente</li>
</ul>
</li>
<li>
<p><code>GPIO_V2_LINE_SET_CONFIG_IOCTL</code>, cambiar la configuración de una línea:</p>
<ul>
<li>Se pasa un argumento <code>struct gpio_v2_line_config</code></li>
<li>No es necesario liberar la línea antes</li>
</ul>
</li>
</ul>
<h2 id="gpio-mapeado-en-memoria">GPIO mapeado en memoria<a class="headerlink" href="#gpio-mapeado-en-memoria" title="Permanent link">&para;</a></h2>
<p>Linux incorpora el dispositivo /dev/mem que permite acceder a la memoria física
del computador. El offset en este fichero es interpretado como una dirección
física y el driver controla los rangos accesibles (configurable con la opción de
compilación del kernel <em>CONFIG_STRICT_DEVMEM</em>) en función de la arquitectura del
computador. Sólo root tiene acceso a este dispositvo, ya que usarlo implica
saltarse prácticamente todos los mecanismos de control y las abstracciones del
sistema operativo.</p>
<p>Raspbian incorpora también el dispositivo /dev/gpiomem, que es un dispositivo
que permite el acceso al rango de direcciones físicas controlado por el GPIO.
Todos los usuarios que pertenezcan al grupo gpio tienen acceso a este fichero,
además de root. Este fichero permite acceder <em>en crudo</em> a los registros del gpio
puenteando al driver gpio. Aunque no se recomienda su uso (mejor utilizar el
driver gpio), puede ser útil usarlo para estudiar el funcionamiento del
controlador gpio.</p>
<p>Como ejemplo vamos a ver cómo podemos implementar el ejemplo gpio_blink
utilizando este dispositivo. Para ello primero debemos revisar la documentación
de Broadcom para ver cómo funciona el controlador GPIO. Resumimos aquí los
aspectos más destacados.</p>
<p>En el controlador GPIO la función de cada pin se configura en los registros de
selección <em>GPFSELn</em>:</p>
<table>
<thead>
<tr>
<th>Registro</th>
<th><strong>Dir. Física</strong></th>
<th><strong>Pines GPI</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>GPFSEL0</td>
<td>0x3F200000</td>
<td>GPIO0 - GPIO9</td>
</tr>
<tr>
<td>GPFSEL1</td>
<td>0x3F200004</td>
<td>GPIO10 - GPIO19</td>
</tr>
<tr>
<td>GPFSEL2</td>
<td>0x3F200008</td>
<td>GPIO20 - GPIO29</td>
</tr>
<tr>
<td>GPFSEL3</td>
<td>0x3F20000C</td>
<td>GPIO30 - GPIO39</td>
</tr>
<tr>
<td>GPFSEL4</td>
<td>0x3F200010</td>
<td>GPIO40 - GPIO49</td>
</tr>
<tr>
<td>GPFSEL5</td>
<td>0x3F200014</td>
<td>GPIO50 - GPIO53</td>
</tr>
</tbody>
</table>
<p>Se utilizan tres bits por pin, con la codificación indicada en la siguiente
tabla:</p>
<table>
<thead>
<tr>
<th></th>
<th><strong>Función (según doc. Broadcom</strong>)</th>
</tr>
</thead>
<tbody>
<tr>
<td>000</td>
<td>Entrada</td>
</tr>
<tr>
<td>001</td>
<td>Salida</td>
</tr>
<tr>
<td>100</td>
<td>Función alternativa 0</td>
</tr>
<tr>
<td>101</td>
<td>Función alternativa 1</td>
</tr>
<tr>
<td>110</td>
<td>Función alternativa 2</td>
</tr>
<tr>
<td>111</td>
<td>Función alternativa 3</td>
</tr>
<tr>
<td>011</td>
<td>Función alternativa 4</td>
</tr>
<tr>
<td>010</td>
<td>Función alternativa 5</td>
</tr>
</tbody>
</table>
<p>Para operar sobre los pines de salida hay dos pares de registros:</p>
<table>
<thead>
<tr>
<th>Valor</th>
<th>Pin</th>
<th>Registro</th>
<th>Dirección (ARM)</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>0-31</td>
<td>GPFSET0</td>
<td>0x3F20001C</td>
</tr>
<tr>
<td>1</td>
<td>32-53</td>
<td>GPFSET1</td>
<td>0x3F200020</td>
</tr>
<tr>
<td>0</td>
<td>0-31</td>
<td>GPFCLR0</td>
<td>0x3F200028</td>
</tr>
<tr>
<td>0</td>
<td>32-53</td>
<td>GPFCLR1</td>
<td>0x3F20002C</td>
</tr>
</tbody>
</table>
<p>Así, para poner a 1 un pin de salida debemos escribir un 1 en la posición
correspondiente del registro GPSET que corresponda. Y para poner dicho pin a 0
deberemos escribir un 1 en el la misma posición del registro GPCLR
correspondiente. Escribir un 0 no modifica el valor del pin.</p>
<p>El programa <a href="src/gpio_blink_mem.c">gpio_blink_mem</a> proyectan el dispositivo
<em>/dev/gpiomem</em> en el mapa virtual de memoria del proceso utilizando mmap, con el
fin de acceder diréctamente a los registros del controlador. Se utilizan unos
arrays para almacenar los offsets de los registros:</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-18-1"><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a><span class="kt">uint32_t</span><span class="w"> </span><span class="n">gpfsel_offset</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x04</span><span class="p">,</span><span class="mh">0x08</span><span class="p">,</span><span class="mh">0x0C</span><span class="p">,</span><span class="mh">0x10</span><span class="p">,</span><span class="mh">0x14</span><span class="p">};</span>
</span><span id="__span-18-2"><a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a><span class="kt">uint32_t</span><span class="w"> </span><span class="n">gpfset_offset</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mh">0x1C</span><span class="p">,</span><span class="w"> </span><span class="mh">0x20</span><span class="p">};</span>
</span><span id="__span-18-3"><a id="__codelineno-18-3" name="__codelineno-18-3" href="#__codelineno-18-3"></a><span class="kt">uint32_t</span><span class="w"> </span><span class="n">gpfclr_offset</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mh">0x28</span><span class="p">,</span><span class="w"> </span><span class="mh">0x2C</span><span class="p">};</span>
</span></code></pre></div>
<p>Estos offsets se suman a la dirección base que es un puntero a byte,
convirtiendo el resultado a un puntero a <em>uint32_t</em> por conveniencia:</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-19-1"><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a><span class="w">    </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="n">gpiomem</span><span class="p">;</span>
</span><span id="__span-19-2"><a id="__codelineno-19-2" name="__codelineno-19-2" href="#__codelineno-19-2"></a><span class="w">    </span><span class="k">volatile</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">fpsel</span><span class="p">;</span>
</span><span id="__span-19-3"><a id="__codelineno-19-3" name="__codelineno-19-3" href="#__codelineno-19-3"></a><span class="w">  </span><span class="p">...</span>
</span><span id="__span-19-4"><a id="__codelineno-19-4" name="__codelineno-19-4" href="#__codelineno-19-4"></a><span class="w">    </span><span class="n">gpiomem</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mmap</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="mi">4096</span><span class="p">,</span><span class="w"> </span><span class="n">PROT_READ</span><span class="o">|</span><span class="n">PROT_WRITE</span><span class="p">,</span><span class="w"> </span><span class="n">MAP_SHARED</span><span class="p">,</span><span class="w"> </span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="mh">0x3f200000</span><span class="p">);</span>
</span><span id="__span-19-5"><a id="__codelineno-19-5" name="__codelineno-19-5" href="#__codelineno-19-5"></a><span class="w">  </span><span class="p">...</span>
</span><span id="__span-19-6"><a id="__codelineno-19-6" name="__codelineno-19-6" href="#__codelineno-19-6"></a><span class="w">    </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_int</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="n">desc</span><span class="p">);</span>
</span><span id="__span-19-7"><a id="__codelineno-19-7" name="__codelineno-19-7" href="#__codelineno-19-7"></a><span class="w">    </span><span class="n">fpsel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">uint32_t</span><span class="w"> </span><span class="o">*</span><span class="p">)(</span><span class="n">gpiomem</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">gpfsel_offset</span><span class="p">[</span><span class="n">n</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">10</span><span class="p">]);</span>
</span></code></pre></div>
<p>Las escrituras en los registros se hacen desreferenciado los punteros, que se
han declarado como volátiles:</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-20-1"><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a><span class="w">    </span><span class="o">*</span><span class="n">fpsel</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="p">(</span><span class="mh">0x1</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mi">10</span><span class="p">)</span><span class="o">*</span><span class="mi">3</span><span class="p">);</span>
</span></code></pre></div>
<p>Aunque este mecanismo permite controlar los gpios, debemos notar que el código
es muy dependiente del hardware, utilizando offsets y selecciones de registros
en función del número de pin o la operación a realizar; y escogiendo
adecuadamente los códigos a escribir en los registros siguiendo la documentación
del fabricante del SoC. Notemos además que el estado de los leds se mantiene
cuando el programa termina, y puede entrar en conflicto con cualquier otro
proceso que use el driver del sistema para el gpio. Este código es mucho más
propenso a errores que no serán identificados por el sistema (no hay valor de
retorno de error).</p>
<p>La librería <a href="https://www.airspayce.com/mikem/bcm2835/">bcm2835</a> usa entrada
salida mapeada en memoria y ofrece un API más sencillo y práctico para el manejo
de los controladores de la raspberry pi, pero sigue saltándose todos los
controles del sistema operativo, por lo que resulta más adecuando aprender a
utilizar el driver GPIO estudiado en la sección anterior.</p>

              
            </article>
          </div>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Footer">
      
        
        <a href=".." class="md-footer__link md-footer__link--prev" aria-label="Previous: Placa de expansión BEE" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Placa de expansión BEE
            </div>
          </div>
        </a>
      
      
        
        <a href="../pwm_linux/" class="md-footer__link md-footer__link--next" aria-label="Next: Control PWM en Linux" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              Control PWM en Linux
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "..", "features": ["toc.integrate"], "search": "../assets/javascripts/workers/search.bd0b6b67.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.467223ff.min.js"></script>
      
        <script src="../javascripts/mathjax.js"></script>
      
        <script src="https://unpkg.com/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>