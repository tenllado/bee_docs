
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.4.2, mkdocs-material-8.2.5">
    
    
      
        <title>Control PWM en Linux - BEE Docs</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.2d9f7617.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.e6a45f82.min.css">
        
      
    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#control-pwm-en-linux" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="BEE Docs" class="md-header__button md-logo" aria-label="BEE Docs" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            BEE Docs
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Control PWM en Linux
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  

<nav class="md-nav md-nav--primary md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="BEE Docs" class="md-nav__button md-logo" aria-label="BEE Docs" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    BEE Docs
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_1" type="checkbox" id="__nav_1" >
      
      
      
      
        <label class="md-nav__link" for="__nav_1">
          Documentación Técnica
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Documentación Técnica" data-md-level="1">
        <label class="md-nav__title" for="__nav_1">
          <span class="md-nav__icon md-icon"></span>
          Documentación Técnica
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        Placa de expansión BEE
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_2">
          Prácticas
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Prácticas" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Prácticas
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../gpio_linux/" class="md-nav__link">
        Control GPIO en Linux
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Control PWM en Linux
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Control PWM en Linux
      </a>
      
        

  

<nav class="md-nav md-nav--secondary" aria-label="On this page">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      On this page
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#senales-pwm" class="md-nav__link">
    Señales PWM
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#interfaz-sysfs" class="md-nav__link">
    Interfaz sysfs
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pwm-por-software" class="md-nav__link">
    PWM por software
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../spi_linux/" class="md-nav__link">
        Control de dispositivos SPI
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../i2c_linux/" class="md-nav__link">
        Control de dispositivos I2C
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../control_servomotores/" class="md-nav__link">
        Control de servomotores con PWM
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../robotica/" class="md-nav__link">
        Prácticas de Robótica
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                


<h1 id="control-pwm-en-linux">Control PWM en Linux<a class="headerlink" href="#control-pwm-en-linux" title="Permanent link">&para;</a></h1>
<p>En esta práctica vamos a estudiar cómo podemos utilizar los controladores PWM
desde un programa de usuario en Linux.</p>
<h2 id="senales-pwm">Señales PWM<a class="headerlink" href="#senales-pwm" title="Permanent link">&para;</a></h2>
<p>Las señales de modulación de ancho de pulso (Pulse Width Modulation, PWM) se
describen en la siguiente figura:</p>
<p><img alt="PWM Signal" src="fig/pwm.png" /></p>
<p>Se trata de una señal rectangular de un periodo fijo, en la que la fracción del
periodo en que la señal toma un valor distinto de cero se define como <em>duty
cycle</em>. Sin embargo, muchos interfaces de control PWM toman el duty cycle como
el tiempo absoluto en que la señal está activa, que debe ser menor que la
duración (absoluta) del periodo. Este tipo de señales se utilizan frecuentemente
para el control de servos y la conversión digital analógica (en ausencia de
DAC).</p>
<h2 id="interfaz-sysfs">Interfaz sysfs<a class="headerlink" href="#interfaz-sysfs" title="Permanent link">&para;</a></h2>
<p>En la raspberry pi hay dos controladores pwm hardware, con la misma señal de
reloj (19.2 MHz). Aunque puede obtenerse su salida por varios pines distintos,
para la placa de expansión BEE es conveniente usar para el pwm0 el pin 18 o el
pin 12 y para el pwm1 el pin 13. Los dos controladores son usados por el sistema
de audio.</p>
<p>El driver de pwm ofrece actualmente un interfaz a través del sistema virtual de
ficheros sysfs. Debe ser habilitado cargando el overlay pwm-2chan. Esto puede
hacerse de dos formas:</p>
<ul>
<li>Dinámicamente con:
    <div class="language-bash highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a>sudo<span class="w"> </span>dtoverlay<span class="w"> </span>pwm-2chan<span class="w"> </span><span class="nv">pin</span><span class="o">=</span><span class="m">18</span><span class="w"> </span><span class="nv">func</span><span class="o">=</span><span class="m">2</span><span class="w"> </span><span class="nv">pin2</span><span class="o">=</span><span class="m">13</span><span class="w"> </span><span class="nv">func2</span><span class="o">=</span><span class="m">4</span>
</span></code></pre></div></li>
<li>En arranque, si añadimos al fichero \texttt{config.txt} la línea:
    <div class="language-bash highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="nv">dtoverlay</span><span class="o">=</span>pwm-2chan,pin<span class="o">=</span><span class="m">18</span>,func<span class="o">=</span><span class="m">2</span>,pin2<span class="o">=</span><span class="m">13</span>,func2<span class="o">=</span><span class="m">4</span>
</span></code></pre></div></li>
</ul>
<p>Una vez habilitado nos aparecerá el directorio <code>/sys/class/pwm/pwmchip0</code> con los
siguientes ficheros: device, export, npwm, power, subsystem, uevent y unexport.</p>
<p>Para poder usar los canales pwm primero hay que exportarlos escribiendo el
número del canal a usar en el fichero export:</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a>$<span class="w"> </span><span class="nb">echo</span><span class="w"> </span><span class="m">0</span><span class="w"> </span>&gt;<span class="w"> </span>/sys/class/pwm/pwmchip0/export
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a>$<span class="w"> </span><span class="nb">echo</span><span class="w"> </span><span class="m">1</span><span class="w"> </span>&gt;<span class="w"> </span>/sys/class/pwm/pwmchip0/export
</span></code></pre></div>
<p>Una vez exportados nos aparecerán dos nuevos directorios: <em>pwm0</em> y <em>pwm1</em>, con
los siguientes ficheros: <em>capture</em>, <em>duty_cycle</em>, <em>enable</em>, <em>period</em>,
<em>polarity</em>, <em>power</em> y <em>uevent</em>. El sistema genera un <em>evento udev</em> cuando
aparecen y hay que esperar este evento para poder continuar (ver ejemplo).</p>
<p>Una vez que se dispare el evento podemos usar un canal. Para ello debemos seguir
el siguiente procedimiento:</p>
<ol>
<li>Escribir el periodo en ns en el fichero <em>period</em> </li>
<li>Escribir el duty cycle en ns en el fichero <em>duty_cycle</em></li>
<li>Escribir un 1 en el fichero <em>enable</em></li>
</ol>
<p>Podemos cambiar dinámicamente el periodo y/o el duty cycle o apagar un canal
escribiendo un 0 en el fichero <em>enable</em>. Cuando queramos dejar de usar un canal
deberemos escribir su número en el fichero <em>unexport</em>.</p>
<p>Como ejemplo, el script bash <a href="src/servo_cont_rot.sh">servo_cont_rot.sh</a> ofrece
un interfaz de línea de comandos para el control de un servo de rotación
continual de parallax. Si se dispone de uno de estos servos, se puede probar
conectándolo a los pines indicados arriba. Podemos ejecutar el script sin
parámetros o con -h para ver la lista de opciones.</p>
<p>El programa <a href="src/servo_control.c">servo_control.c</a> es un ejemplo de como
controlar el mismo servo de rotación continua de parallax desde un programa C.
Utiliza 3 pulsadores conectados a tres pines del gpio para controlar el servo.
El programa recibe como argumentos: el fichero del controlador gpio, el canal de
pwm a usar y los tres pines a usar como entrada. Uno de los botones permite
decrementar el duty cycle, otro incrementarlo y otro parar el servo. El programa
exporta el canal pwm indicado y espera a que el kernel notifique que está
montado (esperando eventos de udev). Si el pwm ya está exportado da un aviso
pero sigue adelante.</p>
<h2 id="pwm-por-software">PWM por software<a class="headerlink" href="#pwm-por-software" title="Permanent link">&para;</a></h2>
<p>En lugar de utilizar controladores PWM hardware, es posible utilizar pines
genéricos del GPIO para generar una señal PWM por software. Si es posible, sería
mejor crear para ello una tarea de tiempo real, aunque esto queda fuera del
alcance de esta práctica.</p>
<p>Tenemos dos alternativas:</p>
<ul>
<li>
<p>Usar <em>clock_nanosleep</em> con el flag <em>TIMER_ABSTIME</em>, usando dos intervalos, uno
  para el periodo y otro para el duty cycle. De esta forma, se espera
  (<em>clock_nanosleep</em>) un periodo,</p>
</li>
<li>
<p>Usar timers POSIX, con un timer periódico para el periodo y uno one shot para
  el duty cycle, activado en cada periodo. </p>
</li>
</ul>
<p>Probar estas alternativas se deja como ejercicio al estudiante interesado.</p>
<p>La limitación de esta estrategia es la precisión de la señal, que estará
expuesta a la variabilidad del tiempo de respuesta del kernel (jitter). Este
jitter puede llegar a medirse con un osciloscopio. Puede mejorarse utilizando un
kernel de tiempo real y tareas de tiempo real.</p>

              
            </article>
          </div>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Footer">
      
        
        <a href="../gpio_linux/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Control GPIO en Linux" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Control GPIO en Linux
            </div>
          </div>
        </a>
      
      
        
        <a href="../spi_linux/" class="md-footer__link md-footer__link--next" aria-label="Next: Control de dispositivos SPI" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              Control de dispositivos SPI
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "..", "features": ["toc.integrate"], "search": "../assets/javascripts/workers/search.bd0b6b67.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.467223ff.min.js"></script>
      
        <script src="../javascripts/mathjax.js"></script>
      
        <script src="https://unpkg.com/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>